<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
  />
  <title>Style Awareness - CommuniCoach</title>

  <!-- Fonts + Icons -->
  <link
    href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap"
    rel="stylesheet"
  />
  <link
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    rel="stylesheet"
  />

  <!-- ======= COMBINED CSS ======= -->
  <style>
    :root {
      --primary-color: #2d4a3e;
      --secondary-color: #1b4072;
      --accent-color: #a1ce3e;
      --highlight-color: #dcefc6;
      --energy-color: #74b49b;
      --error-color: #ff6b6b;
      --success-color: #4CAF50;
      --shadow-color: rgba(45, 74, 62, 0.15);

      --bg-color: #ffffff;
      --bg-secondary: #f9fef3;
      --bg-card: #ffffff;

      --text-primary: #2d4a3e;
      --text-secondary: #555;
      --text-light: #ffffff;

      --border-color: #e0e0e0;
      --input-bg: #ffffff;

      --progress-bg: #e0e0e0;
      --progress-fill: #136f6f;

      --user-bubble-bg: #e8f4f8;
      --partner-bubble-bg: #f0f0f0;
      --coach-bubble-bg: #dcefc6;

      --gradient-bg: linear-gradient(
        135deg,
        rgba(45, 74, 62, 0.05),
        rgba(161, 206, 62, 0.07)
      );
    }

    [data-theme="dark"] {
      --primary-color: #78a891;
      --secondary-color: #60a3d9;
      --accent-color: #a1ce3e; 
      --highlight-color: #314a2e;
      --shadow-color: rgba(0, 0, 0, 0.25);

      --bg-color: #121212;
      --bg-secondary: #1e1e1e;
      --bg-card: #242424;

      --text-primary: #e0e0e0;
      --text-secondary: #aaaaaa;

      --border-color: #444444;
      --input-bg: #333333;

      --progress-bg: #444444;
      --progress-fill: #78c7ba;

      --user-bubble-bg: #2d4a3e;
      --partner-bubble-bg: #333333;
      --coach-bubble-bg: #314a2e;
    }

    /* Global resets & transitions */
    * {
      box-sizing: border-box;
    }
    html, body {
      margin: 0; padding: 0;
      width: 100%; height: 100%;
      font-family: "Poppins", sans-serif;
      background-color: var(--bg-color);
      color: var(--text-primary);
      transition: background-color 0.3s, color 0.3s;
      overflow-x: hidden;
    }
    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background: var(--bg-secondary);
      opacity: 0.8;
      z-index: -1;
    }

    /* Header & Nav */
    .header-wrapper {
      position: fixed; top: 0; left: 0;
      width: 100%;
      background: var(--bg-card);
      backdrop-filter: blur(10px);
      z-index: 1000;
      box-shadow: 0 2px 20px var(--shadow-color);
    }
    .top-nav {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 20px;
      padding: 15px 0;
      color: var(--text-primary);
      position: relative;
    }
    .top-nav a {
      color: var(--text-primary);
      text-decoration: none;
      padding: 5px 10px;
      border-radius: 20px;
      transition: all 0.3s ease;
    }
    .top-nav a:hover {
      background: var(--highlight-color);
    }
    .top-nav a.current {
      background: #136f6f;
      color: var(--text-light);
    }
    .logo {
      position: absolute;
      left: 20px;
    }
    .logo img {
      height: 40px;
    }
    .mobile-menu-button {
      display: none;
      background: none; border: none; 
      font-size: 1.5rem; cursor: pointer;
      color: var(--text-primary);
      position: absolute; right: 20px; top: 15px;
    }
    .nav-links.active { display: flex; }

    /* Dark Mode Toggle */
    .dark-mode-toggle {
      position: absolute; right: 20px;
      display: flex; align-items: center; gap: 10px;
    }
    .toggle-label {
      font-size: 0.9rem;
      color: var(--text-primary);
    }
    .switch {
      position: relative; display: inline-block;
      width: 50px; height: 24px;
    }
    .switch input {
      opacity: 0; width: 0; height: 0;
    }
    .slider {
      position: absolute; cursor: pointer; 
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: #ccc; transition: .4s;
    }
    .slider:before {
      content: ""; position: absolute;
      height: 16px; width: 16px;
      left: 4px; bottom: 4px;
      background-color: #fff;
      transition: .4s;
    }
    input:checked + .slider {
      background-color: var(--accent-color);
    }
    input:checked + .slider:before {
      transform: translateX(26px);
    }
    .slider.round {
      border-radius: 34px;
    }
    .slider.round:before {
      border-radius: 50%;
    }

    /* Progress Bar */
    .progress-bar-container {
      width: 100%; padding: 10px 0;
      background: var(--bg-secondary);
    }
    .progress-bar {
      width: 80%; margin: 0 auto;
      height: 8px; background: var(--progress-bg);
      border-radius: 4px; overflow: hidden;
    }
    .progress-bar .progress {
      width: 10%;
      height: 100%;
      background: var(--progress-fill);
      border-radius: 4px;
      transition: width 0.5s ease;
    }

    /* Hero Section */
    .hero-section {
      margin-top: 100px;
      padding: 4rem 0;
    }
    .container {
      max-width:1200px; margin:0 auto;
      padding: 0 2rem; position:relative;
    }
    .hero-content {
      display: flex; gap: 3rem;
      align-items: center;
    }
    .hero-text {
      flex:1.2;
    }
    .hero-text h1 {
      font-size: 1.8em; 
      margin-bottom: 1rem;
      color: var(--text-primary);
      font-weight: 600;
    }
    .hero-text p {
      font-size: 1em; margin-bottom: 1rem;
      color: var(--text-primary);
    }
    .hero-image {
      flex:1;
    }
    .hero-image img {
      width: 100%; border-radius:15px;
      box-shadow:0 4px 15px var(--shadow-color);
    }
    /* Persuasion Mini-Lesson Overlay */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.6);
  display: none;
  justify-content: center;
  align-items: flex-start;
  overflow-y: auto;
  z-index: 1001;
  padding: 2rem 1rem;
}

.modal-overlay.active {
  display: flex;
}

.lesson-modal {
  background: var(--bg-card);
  max-width: 800px;
  width: 100%;
  padding: 2rem;
  border-radius: 15px;
  box-shadow: 0 10px 30px var(--shadow-color);
  animation: fadeIn 0.5s ease;
  position: relative;
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1.5rem;
}

.modal-header h2 {
  font-size: 1.4em;
  color: var(--text-primary);
}

.modal-close {
  font-size: 1.5em;
  background: none;
  border: none;
  color: var(--text-primary);
  cursor: pointer;
}

.lesson-cards {
  display: flex;
  flex-direction: column;
  gap: 1rem;
  margin-bottom: 2rem;
}

.lesson-card {
  background: var(--bg-secondary);
  border-radius: 12px;
  padding: 1rem 1.2rem;
  cursor: pointer;
  box-shadow: 0 2px 10px var(--shadow-color);
  transition: all 0.3s ease;
}

.lesson-card h3 {
  margin: 0;
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-size: 1.1em;
  color: var(--primary-color);
}

.lesson-card-content {
  display: none;
  padding-top: 0.8rem;
  font-size: 0.95em;
  color: var(--text-secondary);
}

.lesson-card.open .lesson-card-content {
  display: block;
}

.lesson-text-section {
  font-size: 0.95em;
  color: var(--text-primary);
}

.lesson-text-section h4 {
  margin-top: 1.5rem;
  font-size: 1.1em;
  color: var(--primary-color);
}
.lesson-card-content {
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.4s ease, opacity 0.4s ease;
  opacity: 0;
}

.lesson-card.open .lesson-card-content {
  max-height: 200px;
  opacity: 1;
}
.lesson-card.open {
  background: var(--highlight-color);
  border: 2px solid var(--accent-color);
}


.lesson-footer {
  margin-top: 2rem;
  text-align: center;
}

@media (max-width: 600px) {
  .lesson-modal {
    padding: 1.5rem;
  }

  .lesson-card h3 {
    font-size: 1em;
  }

  .modal-header h2 {
    font-size: 1.2em;
  }
}
  

    /* Setup & scenario + goal */
    .setup-section { padding: 2rem 0; }
    .setup-card {
      background: var(--bg-card);
      border-radius: 15px;
      padding: 2rem;
      box-shadow: 0 4px 20px var(--shadow-color);
      margin-bottom: 2rem;
    }
    #persuasionGoalInput {
  width: 100%;
  padding: 0.8rem;
  font-size: 1em;
  font-family: 'Poppins', sans-serif;
  background: var(--input-bg);
  color: var(--text-primary);
  border: 2px solid var(--border-color);
  border-radius: 10px;
  transition: border-color 0.3s ease, box-shadow 0.3s ease;
  box-sizing: border-box;
}

#persuasionGoalInput:focus {
  outline: none;
  border-color: var(--accent-color);
  box-shadow: 0 0 0 3px rgba(161, 206, 62, 0.2);
}
#partnerNameInput {
  width: 100%;
  padding: 0.8rem;
  font-size: 1em;
  font-family: 'Poppins', sans-serif;
  background: var(--input-bg);
  color: var(--text-primary);
  border: 2px solid var(--border-color);
  border-radius: 10px;
  transition: border-color 0.3s ease, box-shadow 0.3s ease;
  box-sizing: border-box;
}

#partnerNameInput:focus {
  outline: none;
  border-color: var(--accent-color);
  box-shadow: 0 0 0 3px rgba(161, 206, 62, 0.2);
}


    .persuasion-card {
  background: var(--bg-secondary);
  border-radius: 12px;
  padding: 1.5rem;
  margin-top: 2rem;
  box-shadow: 0 2px 12px var(--shadow-color);
}

.persuasion-card h3 {
  color: var(--primary-color);
  margin-bottom: 0.5rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.persuasion-card p {
  font-size: 0.95em;
  color: var(--text-secondary);
  margin-bottom: 0.8rem;
}

.coach-suggestion {
  background: var(--highlight-color);
  padding: 0.8rem;
  border-radius: 10px;
  font-size: 0.9em;
  margin-top: 0.5rem;
  margin-bottom: 1rem;
  display: none;
}
    .response-input {
      width: 100%;
      padding: 0.8rem;
      border: 2px solid var(--border-color);
      border-radius: 10px;
      background: var(--input-bg);
      color: var(--text-primary);
      margin-bottom: 1rem;
      font-family: "Poppins", sans-serif;
    }
    .response-input:focus {
      outline: none;
      border-color: var(--accent-color);
      box-shadow: 0 0 0 3px rgba(161, 206, 62, 0.2);
    }
    

    .setup-card h2 {
        display: flex;
    align-items: center;
    gap: 10px;
    font-size: 1.4em;
    color: var(--text-primary);
    margin-bottom: 1.5rem;
    }
    .setup-card p {
        padding: 1.5rem;
    border: 2px solid var(--accent-color);
    border-radius: 10px;
    background: var(--highlight-color);
    color: var(--text-primary);
    font-size: 0.95em;
    line-height: 1.6;
    margin-bottom: 1.5rem;
    }
    .form-group { margin-bottom:1rem; }
    .form-group label {
      display:block;
      margin-bottom:0.3rem;
      font-weight:500;
      color: var(--text-primary);
    }
    .form-group input[readonly] {
      background: var(--bg-secondary);
      border:2px solid var(--border-color);
      border-radius:10px;
      padding:0.7rem;
      width:100%;
      color: var(--text-primary);
    }
    
    /* Style Categories Section */
    .styles-category-heading {
      margin-top: 1.5rem;
      margin-bottom: 0.5rem;
      font-weight: 500;
      color: var(--text-primary);
      font-size: 1em;
      background: var(--highlight-color);
      padding: 0.5rem;
      border-radius: 8px;
    }
    
    .styles-choices {
      display:flex; flex-wrap:wrap;
      gap:0.7rem;
      margin-bottom:1rem;
    }
    .style-checkbox {
      background: var(--bg-secondary);
      border:1px solid var(--border-color);
      border-radius:20px;
      padding:0.5rem 1rem;
      display: flex; align-items:center;
      gap:0.5rem; cursor:pointer;
      transition: all 0.2s ease;
    }
    .style-checkbox:hover {
      background: var(--highlight-color);
      border-color: var(--accent-color);
    }
    .style-checkbox.selected {
      background: var(--highlight-color);
      border-color: var(--accent-color);
    }
    
    .validation-message {
      color: var(--error-color);
      font-size: 0.9em;
      margin-top: 0.5rem;
      display: none;
    }

    .form-actions {
      margin-top:2rem;
      display:flex; gap:1rem;
      justify-content:flex-end;
    }
    .btn {
      padding:0.7rem 1.5rem;
      border-radius:25px;
      border:none; cursor:pointer;
      font-family:"Poppins",sans-serif;
      font-size:1rem;
      transition:all 0.3s ease;
      display:inline-flex;
      align-items:center;
      gap:0.4rem;
    }
    .btn-primary {
      background: var(--primary-color);
      color:#fff;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    .btn-primary:hover {
      transform: translateY(-3px);
      background: var(--secondary-color);
    }
    .coach-suggestion.loading::before {
  content: '⏳ ';
  animation: pulse 1.2s infinite alternate;
}

@keyframes pulse {
  0% { opacity: 0.4; }
  100% { opacity: 1; }
}

    .btn-primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    .btn-outline {
      background:none;
      color: var(--text-primary);
      border:2px solid var(--text-primary);
    }
    .btn-outline:hover {
      background: var(--highlight-color);
    }
    .btn-outline:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    /* The main exercise rounds */
    .exercise-section {
      display:none;
      padding:2rem 0;
    }
    .exercise-card {
      background: var(--bg-card);
      border-radius:15px;
      box-shadow:0 4px 20px var(--shadow-color);
      padding:2rem;
      margin-bottom:2rem;
      position:relative;
    }
    .exercise-header {
      text-align:center;
      margin-bottom:2rem;
    }
    .exercise-header h2 {
      color: var(--text-primary);
      font-size:1.4em;
      margin-bottom:0.5rem;
    }
    .exercise-header p {
      color: var(--text-secondary);
      font-size:1em;
    }
    .round-indicator {
      text-align:right; font-size:1em;
      color: var(--secondary-color);
      margin-bottom:1rem;
    }

    .partner-paragraph {
      padding:1.5rem;
      margin-bottom:1rem;
      background: var(--bg-secondary);
      border-left:4px solid var(--accent-color);
      border-radius:10px;
      color: var(--text-primary);
    }
    .style-guess-row {
      display:flex; flex-wrap:wrap;
      gap:1rem;
      margin-bottom:2rem;
    }
    .style-guess-button {
      padding:0.6rem 1rem;
      border:2px solid var(--border-color);
      border-radius:10px;
      background: var(--bg-secondary);
      color: var(--text-primary);
      cursor:pointer;
      transition:all 0.3s ease;
    }
    .style-guess-button:hover {
      transform: translateY(-3px);
      border-color: var(--accent-color);
      background: var(--highlight-color);
    }
    .style-guess-button.correct {
      border-color: var(--success-color);
      background:#E8F5E9;
    }
    .style-guess-button.incorrect {
      border-color: var(--error-color);
      background:#ffe8e8;
    }
    .style-guess-button:disabled {
      opacity: 0.7;
      cursor: not-allowed;
      transform: none;
    }

    /* Coach Feedback */
    .coach-feedback {
      margin:1.5rem 0;
      padding:1.2rem;
      background: var(--coach-bubble-bg);
      border-left:4px solid var(--accent-color);
      border-radius:10px;
      color: var(--text-primary);
      display: none;
    }
    .coach-feedback h4 {
      margin-top: 0;
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .coach-feedback h4 i {
      color: var(--accent-color);
    }
    .coach-feedback p {
      margin-bottom: 0;
    }

    /* Response section */
    .response-section {
      margin-bottom:2rem;
    }
    .response-section label {
      font-weight:500;
      color: var(--text-primary);
    }
    .mic-row {
      display:flex; gap:1rem; align-items:center;
      margin-bottom:1rem;
    }
    .mic-button {
      width:50px; height:50px; 
      border:none; border-radius:50%;
      background: var(--accent-color);
      color:#fff; font-size:1.2rem;
      cursor:pointer; box-shadow:0 2px 10px var(--shadow-color);
      display:flex; align-items:center; justify-content:center;
      transition:all 0.3s ease;
    }
    .mic-button:hover {
      transform: scale(1.05);
      background: var(--energy-color);
    }
    .mic-button.listening {
      background: var(--error-color);
      animation: pulseMic 1.2s infinite;
    }
    @keyframes pulseMic {
      0% { box-shadow:0 0 0 0 rgba(255,0,0,0.4); }
      70% { box-shadow:0 0 0 10px rgba(255,0,0,0); }
      100% { box-shadow:0 0 0 0 rgba(255,0,0,0); }
    }

    .response-textarea {
      width:100%;
      padding:0.8rem;
      min-height:100px;
      border:2px solid var(--border-color);
      border-radius:10px;
      background: var(--input-bg);
      color: var(--text-primary);
      margin-bottom:1rem;
      font-family:"Poppins",sans-serif;
    }
    .response-textarea:focus {
      outline:none;
      border-color: var(--accent-color);
      box-shadow:0 0 0 3px rgba(161,206,62,0.2);
    }
    
    /* Generate Response Button */
    .generate-response-btn {
      padding: 0.7rem 1.5rem;
      border: 2px solid var(--primary-color);
      border-radius: 25px;
      background: none;
      color: var(--primary-color);
      font-family: "Poppins", sans-serif;
      font-size: 0.9rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 1rem;
      transition: all 0.3s ease;
    }
    .generate-response-btn:hover {
      background: var(--highlight-color);
      transform: translateY(-2px);
    }
    .generate-response-btn i {
      font-size: 1rem;
    }
    
    .style-selection-row {
      display:flex; flex-wrap:wrap;
      gap:0.7rem;
      margin-bottom:1rem;
    }
    .response-style-button {
      padding:0.6rem 1rem;
      border:2px solid var(--border-color);
      border-radius:10px;
      background: var(--bg-secondary);
      color: var(--text-primary);
      cursor:pointer;
      transition:all 0.3s ease;
    }
    .response-style-button:hover {
      transform: translateY(-3px);
      border-color: var(--accent-color);
      background: var(--highlight-color);
    }
    .response-style-button.selected {
      border-color: var(--accent-color);
      background: var(--highlight-color);
    }

    /* Next / Prev Round */
    .round-nav {
      display:flex; justify-content:space-between;
    }
    .round-nav button {
      margin-top:1rem;
    }

    /* Summary */
    .summary-section {
      display:none; 
      padding:2rem 0;
    }
    .summary-card {
      background: var(--bg-card);
      border-radius:15px;
      box-shadow:0 4px 20px var(--shadow-color);
      padding:2rem;
      position:relative;
      max-width:800px; margin:0 auto;
    }
    .summary-header {
      text-align:center; margin-bottom:2rem;
    }
    .summary-header h2 {
      font-size:1.5em;
      color: var(--text-primary);
      margin-bottom:1rem;
    }
    
    /* Improved Summary Layout */
    .summary-insights {
      color: var(--text-primary);
      line-height:1.6;
      font-size:1em;
      margin-bottom:2rem;
    }
    .summary-section-title {
      font-weight: 600;
      color: var(--primary-color);
      margin-bottom: 0.5rem;
      margin-top: 1.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .summary-section-title i {
      color: var(--accent-color);
    }
    .summary-section-content {
      background: var(--bg-secondary);
      padding: 1rem;
      border-radius: 10px;
      margin-bottom: 1rem;
    }
    .strength-item, .growth-item {
      margin-bottom: 0.8rem;
      padding-left: 1.5rem;
      position: relative;
    }
    .strength-item:before {
      content: '✓';
      color: var(--success-color);
      position: absolute;
      left: 0;
    }
    .growth-item:before {
      content: '→';
      color: var(--accent-color);
      position: absolute;
      left: 0;
    }
    
    .back-toArena-btn {
      text-align:center;
    }

    /* Toast Notifications */
    .toast {
      position:fixed;
      bottom:20px; left:50%;
      transform:translateX(-50%);
      background: var(--primary-color);
      color:#fff;
      padding:12px 24px;
      border-radius:30px;
      box-shadow:0 4px 15px rgba(0,0,0,0.2);
      z-index:9999;
      animation: fadeInUp 0.3s ease;
    }
    .toast.error {
      background: var(--error-color);
    }
    @keyframes fadeInUp {
      from { opacity:0; transform:translateY(20px);}
      to { opacity:1; transform:translateY(0);}
    }

    /* Spinner */
    @keyframes spin {
      to { transform:rotate(360deg);}
    }

    /* Responsive */
    @media (max-width: 768px) {
      .hero-content {
        flex-direction:column-reverse;
        text-align:center;
        gap:2rem;
      }
      .nav-links {
        display:none; width:100%;
        flex-direction:column; gap:10px;
        text-align:center; padding-top:10px;
      }
      .mobile-menu-button { display:block; }
      .dark-mode-toggle {
        position:static;
        margin-top:10px;
        justify-content:center;
      }
      .mic-row {
        flex-direction:row;
      }
      .container {
        padding:0 1rem;
      }
      .setup-card { padding:1.5rem; }
      .exercise-card { padding:1.5rem; }
      .round-nav { flex-direction:column; gap:1rem; }
      .style-guess-row, .style-selection-row {
        flex-direction:column;
      }
    }
  </style>
</head>

<body>
  <!-- HEADER -->
  <div class="header-wrapper">
    <div class="top-nav">
      <a href="#" class="logo">
        <img src=".vscode/Images/CClogo.png" alt="CommuniCoach" />
      </a>
      <button class="mobile-menu-button" onclick="toggleMenu()">☰</button>
      <div class="nav-links" id="navLinks">
        <a href="welcome.html">Welcome</a>
        <a href="tone-selection.html">Tone Selection</a>
        <a href="situation-room.html">Situation Room</a>
        <a href="refined-narrative.html">Refined Narrative</a>
        <a href="action-arena.html">Action Arena</a>
      </div>

      <!-- Dark Mode Toggle -->
      <div class="dark-mode-toggle">
        <span class="toggle-label">Dark Mode</span>
        <label class="switch">
          <input type="checkbox" id="darkModeToggle" />
          <span class="slider round"></span>
        </label>
      </div>
    </div>
    <div class="progress-bar-container">
      <div class="progress-bar">
        <div class="progress" id="progressBar"></div>
      </div>
    </div>
  </div>

  <!-- HERO -->
  <section class="hero-section">
    <div class="container hero-content">
      <div class="hero-text">
        <h1>Master the Art of Influence</h1>
<p>Welcome to a space designed to sharpen one of the most powerful skills you can have: influence. In this arena, you'll learn how to blend Logos, Pathos, and Ethos—logic, emotion, and credibility—into persuasive conversations that feel natural, not scripted.</p>
<p>Persuade with confidence and authenticity. You’ll build skills in identifying and responding to different communication styles, and you’ll get personalized feedback on your own style. By the end, you’ll have a clearer understanding of how to adapt your approach to different situations and people.</p>
<p>If you're eager, you can dive straight into the practice session and start solving real-world persuasion puzzles. But if you'd like to set yourself up for even greater success, we've built a quick and engaging mini-training that will walk you through the essentials—when to use logic, when to lead with emotion, how to build trust, and how to shift smoothly when the conversation changes.</p>

            
        </p>
        <p>
         
        <button class="btn btn-outline" onclick="openPersuasionLesson()">Start Training</button>

          
        </p>
      </div>
      <div class="hero-image">
        <img src=".vscode/Images/conversation.png" alt="Style Awareness" />
      </div>
    </div>
  </section>

  <!-- SETUP -->
  <!-- PERSUASION SETUP SECTION -->
<section class="exercise-setup-section" id="persuasionSetupSection">
    <div class="container">
      <div class="setup-card fade-in delay-1">
        <h2><i class="fa-solid fa-lightbulb"></i> Prepare Your Persuasion Tools</h2>
        <p>Based on your real scenario and communication goal, let’s map out the persuasive tools you may want to use. You’ll explore logic (Logos), emotion (Pathos), and credibility (Ethos). For each, we’ll help you spot what’s already in your narrative—and what might be missing.</p>
  
        <!-- Narrative Display -->
        <div class="form-group">
          <label for="scenarioDisplay">Your Current Scenario</label>
          <input type="text" id="scenarioDisplay" readonly />
        </div>
  
        <div class="form-group">
          <label for="goalDisplay">Your Communication Goal</label>
          <input type="text" id="goalDisplay" readonly />
        </div>
        <div class="form-group">
            <label for="persuasionGoalInput">Persuasion Goal for This Exercise</label>
            <input type="text" id="persuasionGoalInput" placeholder="Write your goal here..." />
          </div>
          <div class="form-group">
            <label for="partnerNameInput">Who are you speaking with?</label>
            <input type="text" id="partnerNameInput" placeholder="e.g. My dad" />
          </div>
          
                 
  
        <!-- Logos Card -->
        <div class="persuasion-card">
          <h3><i class="fa-solid fa-scale-balanced"></i> Logos (Logic)</h3>
          <p>What facts, data, or logical points could help make your case?</p>
          <button type="button" class="btn btn-outline" onclick="askCoach('logos')">Ask Coach for Help</button>
         
          <div class="coach-suggestion" id="logosSuggestion"></div>
          <textarea id="logosInput" class="response-input" placeholder="Add logic-based examples or evidence you may want to use..."></textarea>
        </div>
  
        <!-- Pathos Card -->
        <div class="persuasion-card">
          <h3><i class="fa-solid fa-heart"></i> Pathos (Emotion)</h3>
          <p>What emotional truths or values do you want to convey?</p>
          <button type="button" class="btn btn-outline" onclick="askCoach('pathos')">Ask Coach for Help</button>
          <div class="coach-suggestion" id="pathosSuggestion"></div>
          <textarea id="pathosInput" class="response-input" placeholder="Write what you feel or what matters emotionally..."></textarea>
        </div>
  
        <!-- Ethos Card -->
        <div class="persuasion-card">
          <h3><i class="fa-solid fa-handshake"></i> Ethos (Credibility)</h3>
          <p>What experience, character, or shared values can build trust?</p>
          <button type="button" class="btn btn-outline" onclick="askCoach('ethos')">Ask Coach for Help</button>
          <div class="coach-suggestion" id="ethosSuggestion"></div>
          <textarea id="ethosInput" class="response-input" placeholder="Note your credibility, experience, or values..."></textarea>
        </div>
  
        <!-- Start Button -->
        <div class="form-actions">
          <button class="btn btn-primary" onclick="beginPersuasionExercise()">Start Persuasion Practice</button>
        </div>
      </div>
    </div>
  </section>
  
        
        

  <!-- EXERCISE (5 ROUNDS) -->
  <section class="exercise-section" id="persuasionExerciseSection">
    <div class="container">
      <div class="exercise-card">
        <div class="exercise-header">
          <h2>Round <span id="roundNumber">1</span> of 5</h2>
          <p>You’ll see a statement that might come from your real conversation partner.

            Select the communication style you think they are using.
            
            The AI coach will reveal the actual style and explain how it shows up in their words.
            
            Then, write your own response back.
            
            Once you respond, you’ll label your own style—and the coach will give feedback on how well it fits.
            
            After 5 rounds, you’ll get personalized insights on how you tend to engage and where you can flex or grow.
            
            This isn’t about being “right”—it’s about learning to see style, intention, and tone with sharper eyes.</p>
        </div>

        <div class="round-indicator">
          Focusing on: <span id="selectedStylesDisplay"></span>
        </div>

        <!-- Partner Paragraph -->
        <div class="partner-paragraph" id="partnerParagraph">
          <!-- AI text goes here -->
        </div>

        <!-- Partner Mood Recognition -->
<div class="style-guess-row" id="moodOptionsRow">
  <!-- Mood buttons will be generated here dynamically -->
</div>

<!-- Mood Feedback -->
<div class="coach-feedback" id="moodFeedbackBox" style="display: none;">
  <h4><i class="fa-solid fa-comment-dots"></i> <span id="moodFeedbackTitle">Partner Mood Insight</span></h4>
  <p id="moodFeedbackContent"></p>
</div>

<!-- Diagnostic Suggestion (Optional) -->
<div class="coach-suggestion" id="diagnosticSuggestionBox" style="display: none;"></div>

        <div id="diagnosticSuggestionBox" class="coach-suggestion" style="display: none;"></div>

        
        <!-- Coach Feedback for Style Identification -->
        <div class="coach-feedback" id="styleGuessFeedback">
          <h4><i class="fa-solid fa-comment-dots"></i> <span id="feedbackTitle">Style Analysis</span></h4>
          <p id="feedbackContent"></p>
        </div>

        <!-- User Response Section -->
        <div class="response-section">
          <label for="userResponse">Your Response:</label>
          <div class="mic-row">
            <button class="mic-button" id="responseMicBtn">
              <i class="fa-solid fa-microphone"></i>
            </button>
            <span id="micStatusText">Click to speak</span>
          </div>
          <textarea class="response-textarea" id="userResponse" placeholder="Type your response here..."></textarea>
          
          <!-- Generate Response Button -->
          <button class="generate-response-btn" id="generateResponseBtn">
            <i class="fa-solid fa-magic"></i> Generate Response
          </button>
          
          <p>Select which style you think your response matches:</p>
          <div class="style-selection-row" id="responseStyleRow"></div>
          
          <!-- Coach Feedback for User's Response Style -->
          <div class="coach-feedback" id="coachFeedback">
            <h4><i class="fa-solid fa-comment-dots"></i> <span>Style Analysis</span></h4>
            <p id="responseFeedbackContent"></p>
          </div>
        </div>

        <!-- Round Nav -->
        <div class="round-nav">
          <button class="btn btn-outline" id="prevRoundBtn" disabled>← Previous</button>
          <button class="btn btn-primary" id="nextRoundBtn">Next →</button>
          <!-- Partner Paragraph --> 
        <div class="partner-paragraph" id="partnerParagraph"></div>

        </div>
      </div>
    </div>
  </section>


  <!-- SUMMARY -->
  <section class="summary-section" id="summarySection">
    <div class="container">
      <div class="summary-card">
        <div class="summary-header">
          <h2>Exercise Complete!</h2>
          <p>You finished identifying styles and practicing your responses. 
             Here's a detailed reflection on your performance.</p>
        </div>
        
        <div class="summary-insights" id="summaryInsights">
          <!-- Summary sections will be inserted here -->
          <div class="summary-section-title">
            <i class="fa-solid fa-star"></i> Overall Performance
          </div>
          <div class="summary-section-content" id="overallPerformance">
            <!-- Overall performance content -->
          </div>
          
          <div class="summary-section-title">
            <i class="fa-solid fa-check-circle"></i> Style Recognition Strengths
          </div>
          <div class="summary-section-content" id="recognitionStrengths">
            <!-- Recognition strengths content -->
          </div>
          
          <div class="summary-section-title">
            <i class="fa-solid fa-pen"></i> Style Expression Strengths
          </div>
          <div class="summary-section-content" id="expressionStrengths">
            <!-- Expression strengths content -->
          </div>
          
          <div class="summary-section-title">
            <i class="fa-solid fa-arrow-trend-up"></i> Growth Opportunities
          </div>
          <div class="summary-section-content" id="growthOpportunities">
            <!-- Growth opportunities content -->
          </div>
          
          <div class="summary-section-title">
            <i class="fa-solid fa-lightbulb"></i> Practical Tips
          </div>
          <div class="summary-section-content" id="practicalTips">
            <!-- Practical tips content -->
          </div>
        </div>
        
        <div class="back-toArena-btn">
          <a class="btn btn-primary" href="action-arena.html">
            Return to Action Arena
          </a>
        </div>
      </div>
    </div>
  </section>
<!-- Mini-Lesson Overlay -->
<div class="modal-overlay" id="persuasionLessonOverlay">
    <div class="lesson-modal">
      <div class="modal-header">
        <h2><i class="fa-solid fa-brain"></i> Mini Lesson: Persuasion Foundations</h2>
        <button class="modal-close" onclick="closePersuasionLesson()">×</button>
      </div>
  
      <!-- Expand/Collapse Cards -->
      <div class="lesson-cards">
        <div class="lesson-card" onclick="toggleLessonCard(this)">
          <h3><i class="fa-solid fa-scale-balanced"></i> Logos (Logic)</h3>
          <div class="lesson-card-content">
            <p>Use facts, evidence, and structure to make your case. Logos persuades the mind. It’s powerful when the other person values clarity, data, or logical cause-and-effect. But too much logic can feel cold if not balanced.</p>
          </div>
        </div>
  
        <div class="lesson-card" onclick="toggleLessonCard(this)">
          <h3><i class="fa-solid fa-heart"></i> Pathos (Emotion)</h3>
          <div class="lesson-card-content">
            <p>Appeal to emotions, values, and human truth. Pathos moves the heart and helps others feel your message. When used authentically, it connects deeply. When overdone, it can feel manipulative.</p>
          </div>
        </div>
  
        <div class="lesson-card" onclick="toggleLessonCard(this)">
          <h3><i class="fa-solid fa-handshake"></i> Ethos (Credibility)</h3>
          <div class="lesson-card-content">
            <p>Build trust by showing you are credible, experienced, or aligned with their values. Ethos persuades through character. It’s especially important early in conversations or when trust is low.</p>
          </div>
        </div>
      </div>
  
      <!-- Additional Mini-Lesson Content -->
      <div class="lesson-text-section">
        <h4>Blending the Pieces</h4>
        <p>Real persuasion is not one-note. It's a blend. Logos, Pathos, and Ethos work best when used together, depending on who you’re speaking to and how the conversation evolves.</p>
  
        <h4>Reading the Room</h4>
        <p>Pay attention: Are they asking questions? Seeming emotional? Doubting your credibility? Their energy tells you what they need next—facts, reassurance, or connection.</p>
  
        <h4>Shifting Naturally</h4>
        <p>Use smooth transitions to change tone. “Let me explain why...” ➔ Logos. “Here’s what really matters to me...” ➔ Pathos. “Based on what I’ve seen before...” ➔ Ethos.</p>
  
        <h4>Diagnostic Questions (Optional)</h4>
        <p>Not sure what they need? Ask. “Would it help if I broke it down step-by-step?” or “Can I share why I’m suggesting this?” Great persuasion often begins with a great question.</p>
      </div>
  
      <!-- Close Button -->
      <div class="lesson-footer">
        <button class="btn btn-primary" onclick="closePersuasionLesson()">Return to Setup</button>
      </div>
    </div>
  </div>
  


  <!-- FOOTER -->
  <footer class="footer-nav">
    <p>&copy; 2024 CommuniCoach. All rights reserved.</p>
    <a href="#">Privacy Policy</a>
    <a href="#">Terms of Service</a>
  </footer>


  <!-- ======= JS SCRIPT ======= -->
  <script>
  /******************************************************
   * style-awareness-exercise.js - Enhanced Version
   ******************************************************/
   const state = {
  currentRound: 0,
  maxRounds: 4,
  refinedNarrative: localStorage.getItem('refinedNarrative') || '',
  communicationGoal: localStorage.getItem('communicationGoal') || '',
  persuasionGoal: localStorage.getItem('persuasionGoal') || '',
  partnerName: localStorage.getItem('persuasionPartner') || '',
  logosPrep: localStorage.getItem('logosPrep') || '',
  pathosPrep: localStorage.getItem('pathosPrep') || '',
  ethosPrep: localStorage.getItem('ethosPrep') || '',
  conversationHistory: [], // { speaker, message, type, mood }
  moodCorrectAnswer: '',   // what mood the partner was conveying this round
  moodGuessedCorrectly: false
};
const moods = {
  "Skeptical": {
    persuasionTool: "Logos",
    bucket: "neutral",
    summary: "Doubts reasoning or decisions; often asks 'why' or pushes back on logic.",
    coachTip: "Consider clarifying your reasoning or sharing data that supports your view."
  },
  "Emotionally Resistant": {
    persuasionTool: "Pathos",
    bucket: "counterproductive",
    summary: "Appears guarded, hurt, or reactive; emotions are running high.",
    coachTip: "Lead with empathy or acknowledgment before making a point."
  },
  "Curious": {
    persuasionTool: "Logos + Ethos",
    bucket: "productive",
    summary: "Open to learning more; asks honest questions or explores ideas.",
    coachTip: "Share structured reasoning or a credible experience to keep momentum."
  },
  "Distracted": {
    persuasionTool: "Pathos (gentle)",
    bucket: "neutral",
    summary: "Seems uninvested or mentally elsewhere; energy is low.",
    coachTip: "Use emotional resonance or vivid examples to regain attention."
  },
  "Defensive": {
    persuasionTool: "Pathos + Ethos",
    bucket: "counterproductive",
    summary: "Feels accused or misunderstood; may justify or deflect.",
    coachTip: "Reassure, validate, or reframe rather than pressuring."
  },
  "Challenging Authority": {
    persuasionTool: "Ethos",
    bucket: "counterproductive",
    summary: "Questions your right to lead, decide, or be trusted.",
    coachTip: "Rebuild trust by anchoring to shared values or relevant experience."
  },
  "Overwhelmed": {
    persuasionTool: "Simplified Logos",
    bucket: "neutral",
    summary: "Mentally overloaded; can’t take in much more.",
    coachTip: "Break your message into smaller pieces and simplify the ask."
  },
  "Receptive": {
    persuasionTool: "Ethos Reinforcement",
    bucket: "productive",
    summary: "Open, trusting, and positively engaged.",
    coachTip: "Affirm what’s working and build gently toward your ask."
  }
};


  // DOM Refs
  // DOM Refs – Persuasion Puzzles

// UI Framework
const progressBar = document.getElementById('progressBar');
const navLinks = document.getElementById('navLinks');
const darkModeToggle = document.getElementById('darkModeToggle');

// Setup Phase
const scenarioDisplay = document.getElementById('scenarioDisplay');
const goalDisplay = document.getElementById('goalDisplay');
const persuasionGoalInput = document.getElementById('persuasionGoalInput');
const partnerNameInput = document.getElementById('partnerNameInput');

// Exercise Section
const setupSection = document.getElementById('persuasionSetupSection');
const exerciseSection = document.getElementById('persuasionExerciseSection');
const roundNumberEl = document.getElementById('roundNumber');
const partnerParagraphEl = document.getElementById('partnerParagraph');

// Mood Recognition
const moodOptionsRow = document.getElementById('moodOptionsRow');
const moodFeedbackBox = document.getElementById('moodFeedbackBox');
const moodFeedbackTitle = document.getElementById('moodFeedbackTitle');
const moodFeedbackContent = document.getElementById('moodFeedbackContent');
const diagnosticSuggestionBox = document.getElementById('diagnosticSuggestionBox');

// User Response Input
const userResponseEl = document.getElementById('userResponse');
const responseMicBtn = document.getElementById('responseMicBtn');
const micStatusText = document.getElementById('micStatusText');
const generateResponseBtn = document.getElementById('generateResponseBtn');
const confirmResponseBtn = document.getElementById('confirmResponseBtn');

// Persuasion Remix (Transform)
const transformOptionsRow = document.getElementById('transformOptionsRow');
const previewResponseCard = document.getElementById('previewResponseCard');
const previewResponseContent = document.getElementById('previewResponseContent');
const useTransformedBtn = document.getElementById('useTransformedBtn');

// Final Insights
const insightsSection = document.getElementById('insightsSection');
const conversationSummary = document.getElementById('conversationSummary');
const persuasionStrengths = document.getElementById('persuasionStrengths');
const growthOpportunities = document.getElementById('growthOpportunities');
const nextStepsTips = document.getElementById('nextStepsTips');

// Speech Recognition Globals
let recognition = null;
let isListening = false;
let recognitionTimeout = null;

  
  
  document.addEventListener('DOMContentLoaded', () => {
    initDarkMode();
    loadScenarioAndGoal();
    initSpeechRecognition();

    
    prevRoundBtn.addEventListener('click', handlePrevRound);
    nextRoundBtn.addEventListener('click', handleNextRound);
    responseMicBtn.addEventListener('click', toggleMic);
    generateResponseBtn.addEventListener('click', handleGenerateResponse);
    // 🔜 Will re-enable this after user confirms their response
// nextRoundBtn.disabled = !state.moodGuessedCorrectly;


    exerciseSection.style.display = 'none';
    summarySection.style.display = 'none';
    setProgress(10);
  });

  function toggleMenu() {
    navLinks.classList.toggle('active');
  }

  function initDarkMode() {
    const savedTheme = localStorage.getItem('theme') || 'light';
    if(savedTheme==='dark') {
      document.documentElement.setAttribute('data-theme','dark');
      darkModeToggle.checked = true;
    }
    darkModeToggle.addEventListener('change', ()=>{
      const isDark = darkModeToggle.checked;
      document.documentElement.setAttribute('data-theme', isDark?'dark':'light');
      localStorage.setItem('theme', isDark?'dark':'light');
    });
  }

  function loadScenarioAndGoal() {
    const refined = localStorage.getItem('refinedNarrative') || '(No scenario found)';
    const goal = localStorage.getItem('communicationGoal') || '(No goal found)';
    const persuasionGoalInput = document.getElementById('persuasionGoalInput');
const savedPersuasionGoal = localStorage.getItem('persuasionGoal');
if (persuasionGoalInput && savedPersuasionGoal) {
  persuasionGoalInput.value = savedPersuasionGoal;
}
const partnerNameInput = document.getElementById('partnerNameInput');
const savedPartner = localStorage.getItem('persuasionPartner');
if (partnerNameInput && savedPartner) {
  partnerNameInput.value = savedPartner;
}


    
    // Truncate if too long
    const maxLength = 100;
    const truncatedScenario = refined.length > maxLength ? 
      refined.substring(0, maxLength) + '...' : refined;
    const truncatedGoal = goal.length > maxLength ? 
      goal.substring(0, maxLength) + '...' : goal;
    
    scenarioDisplay.value = truncatedScenario;
    goalDisplay.value = truncatedGoal;
    
    // Save full versions to state
    // Save full versions to state
state.refinedNarrative = refined;
state.communicationGoal = goal;
  }
  




// Start Exercise
function beginPersuasionExercise() {
  const lp = document.getElementById('logosInput')?.value.trim() || '';
  const pp = document.getElementById('pathosInput')?.value.trim() || '';
  const ep = document.getElementById('ethosInput')?.value.trim() || '';
  const specificGoal = document.getElementById('persuasionGoalInput')?.value.trim() || '';
  const partnerName = document.getElementById('partnerNameInput')?.value.trim() || '';

  // Save to localStorage
  localStorage.setItem('logosPrep', lp);
  localStorage.setItem('pathosPrep', pp);
  localStorage.setItem('ethosPrep', ep);
  localStorage.setItem('persuasionGoal', specificGoal);
  localStorage.setItem('persuasionPartner', partnerName);

  setupSection.style.display = 'none';
exerciseSection.style.display = 'block';
setProgress(20); // optional visual update
startRound(0);   // begins the first round
}
function startRound(idx) {
  state.currentRound = idx;
  roundNumberEl.textContent = (idx + 1).toString();

  // Reset visible areas
  partnerParagraphEl.textContent = 'Loading partner message...';
  userResponseEl.value = '';
  moodOptionsRow.innerHTML = '';
  moodFeedbackBox.style.display = 'none';
  diagnosticSuggestionBox.textContent = '';
  previewResponseCard.style.display = 'none';
  confirmResponseBtn.disabled = true;

  // Navigation
  prevRoundBtn.disabled = idx === 0;
  nextRoundBtn.textContent = idx >= state.maxRounds - 1 ? 'Finish' : 'Next →';
  nextRoundBtn.disabled = true;

  // Generate the partner message
  generatePartnerMessage(idx)
    .then(({ message, mood }) => {
      state.moodCorrectAnswer = mood;
      partnerParagraphEl.textContent = message;

      // Save to conversation
      state.conversationHistory.push({
        speaker: state.partnerName,
        message,
        type: 'partner',
        mood: mood
      });

      renderMoodOptions();
    })
    .catch((error) => {
      console.error('Error generating partner message:', error);
    });

  function renderMoodOptions() {
    if (!moodOptionsRow) return;
    moodOptionsRow.innerHTML = '';

    Object.keys(moods).forEach((mood) => {
      const btn = document.createElement('button');
      btn.className = 'style-guess-button';
      btn.textContent = mood;
      btn.title = moods[mood].summary;

      btn.addEventListener('click', () => checkMoodAnswer(mood, btn));
      moodOptionsRow.appendChild(btn);
    });
  }

  function checkMoodAnswer(selectedMood, clickedBtn) {
    const correct = state.moodCorrectAnswer;
    const isCorrect = selectedMood === correct;

    if (isCorrect) {
      // Highlight correct button
      clickedBtn.classList.add('correct');
      disableMoodButtons();
      showMoodFeedback(true, selectedMood);
      state.moodGuessedCorrectly = true;
      generateDiagnosticQuestion(correct);
      nextRoundBtn.disabled = false;
    } else {
      clickedBtn.classList.add('incorrect');
      clickedBtn.disabled = true;
      showMoodFeedback(false, selectedMood);
    }
  }

  function disableMoodButtons() {
    const buttons = moodOptionsRow.querySelectorAll('button');
    buttons.forEach((btn) => (btn.disabled = true));
  }

  function showMoodFeedback(isCorrect, selectedMood) {
    const correct = state.moodCorrectAnswer;
    moodFeedbackBox.style.display = 'block';
    moodFeedbackTitle.textContent = isCorrect ? 'Correct!' : 'Try Again';
    moodFeedbackContent.textContent = isCorrect
      ? `${correct} is correct. ${moods[correct].coachTip}`
      : `That doesn’t seem quite right. Consider how the tone reflects ${selectedMood} vs. ${correct}.`;
  }
}
function generateDiagnosticQuestion(mood) {
  const { refinedNarrative, communicationGoal, persuasionGoal, partnerName } = state;
  const history = formatHistory();
  const suggestionBox = diagnosticSuggestionBox;

  if (!suggestionBox) return;

  suggestionBox.textContent = 'Analyzing…';
  suggestionBox.style.display = 'block';

  const prompt = `
You are CommuniCoach preparing a user for the next step in a real-life persuasive interaction.

CONTEXT:
• Their real-world narrative: "${refinedNarrative}"
• Their communication goal: "${communicationGoal}"
• Their specific persuasion goal: "${persuasionGoal}"
• They are speaking to: ${partnerName}
• The partner's current mood is: ${mood}
• This is part of a realistic training exercise called Persuasion Puzzles.
• The full conversation so far:
${history}

YOUR TASK:
1. Based on the partner’s current mood, suggest one optional **diagnostic question** the user might ask.
2. The goal of this question is to better understand the partner’s needs, hesitations, or perspective — **not** to persuade yet.
3. The question should be natural, non-confrontational, emotionally intelligent, and ideally match the partner’s mood.

RETURN ONLY:
A single persuasive-appropriate diagnostic question the user could say aloud next.
Do NOT label it or add context — just return the text of the question.
`;

  fetch('http://localhost:5506/api/chatgpt', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ prompt })
  })
    .then(res => {
      if (!res.ok) throw new Error(res.statusText);
      return res.json();
    })
    .then(data => {
      suggestionBox.textContent = data.response.trim() || 'No suggestion generated.';
    })
    .catch(err => {
      console.error('Diagnostic question error:', err);
      suggestionBox.textContent = 'Coach unavailable at the moment.';
    });
}



    // Get partner paragraph from API
    async function generatePartnerMessage(roundIndex) {
  const history = formatHistory();
  const { refinedNarrative, communicationGoal, persuasionGoal, partnerName } = state;

  const prompt = `
You are CommuniCoach role-playing as ${partnerName} in a persuasive dialogue simulation.

The user’s real-life situation:
"${refinedNarrative}"

Their communication goal:
"${communicationGoal}"

Their specific persuasion goal for this exercise:
"${persuasionGoal}"

This is round ${roundIndex + 1} of a 4-round practice.

Here is the conversation so far:
${history}

TASK:
Write a realistic 1–3 sentence message as the partner, continuing this conversation naturally.

The tone should reflect the partner's current mood and resistance level. Choose one of the following partner moods and make it CLEAR in the tone and content of the message:
Skeptical, Emotionally Resistant, Curious, Distracted, Defensive, Challenging Authority, Overwhelmed, Receptive

Return your response using this format:
MOOD: [one mood from the list above]  
MESSAGE: [your actual message here]

Guidelines:
• You are not trying to be "nice" — be honest, realistic, even critical if appropriate.
• Make persuasion feel earned. Do not give easy wins.
• Write naturally — like someone would actually speak in this situation.
`;

  try {
    const res = await fetch('http://localhost:5506/api/chatgpt', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ prompt })
    });

    const data = await res.json();
    const text = data.response.trim();

    const moodMatch = text.match(/MOOD:\s*(.*?)(?:\n|$)/i);
    const messageMatch = text.match(/MESSAGE:\s*([\s\S]*)/i);

    return {
      mood: moodMatch ? moodMatch[1].trim() : 'Skeptical',
      message: messageMatch ? messageMatch[1].trim() : '[No partner message returned]'
    };
  } catch (err) {
    console.error('Partner API error:', err);
    return {
      mood: 'Skeptical',
      message: '[Error retrieving message]'
    };
  }
}

  
  

  function renderStyleGuessButtons(correctStyle, distractors) {
    styleGuessRow.innerHTML = '';
    const combined = [correctStyle, ...distractors];
    shuffleArray(combined);

    combined.forEach(st => {
      const btn = document.createElement('button');
      btn.className = 'style-guess-button';
      btn.textContent = st;
      btn.addEventListener('click', () => guessPartnerStyle(st, correctStyle, btn));
      styleGuessRow.appendChild(btn);
    });
  }
  
  function guessPartnerStyle(chosen, correctStyle, btn) {
    const isCorrect = chosen === correctStyle;
    
    // Update UI based on result
    if (isCorrect) {
      btn.classList.add('correct');
      // Disable all buttons after correct guess
      styleGuessRow.querySelectorAll('button').forEach(b => b.disabled = true);
      
      // Store user's guess in state
      exerciseState.rounds[roundIndex].userStyleGuess = chosen;
      
      // Generate and show coach feedback for correct guess
      generateStyleFeedback(chosen, correctStyle, true);
      
      // Enable/render response style buttons after correct guess
      renderResponseStyleButtons();
      
      showToast('Correct style identified!');
    } else {
      btn.classList.add('incorrect');
      btn.disabled = true;
      showToast('Not quite, try another.', 1500, true);
    }
  }
  function askCoach(type) {
  const narrative = localStorage.getItem('refinedNarrative') || '';
  const goal = localStorage.getItem('communicationGoal') || '';
  const persuasionGoal = localStorage.getItem('persuasionGoal') || '';
  const suggestionDiv = document.getElementById(`${type}Suggestion`);
  if (!suggestionDiv) return;

  suggestionDiv.textContent = 'Analyzing...';
  suggestionDiv.style.display = 'block';

  const prompt = `
You are the communication skills coach for CommuniCoach. You are coaching a user in preparing persuasive material for a real conversation based on their 
personal situation: "${narrative}"
• Communication Goal: "${goal}"
• Persuasion Goal: "${persuasionGoal}"

The user's situation may already contain seeds of Logos (logic), Pathos (emotion), and Ethos (credibility), 
but it may also have gaps.

Your task is to coach the user by identifying and strengthening these elements.

Briefly identify what persuasive material already exists under the selected type: ${type.toUpperCase()}.
If it’s missing, briefly suggest what information could strengthen it. Provide specific information 
that would enhance the user's preparation. Write out a sample sentence in the ${type.toUpperCase()} style.

Be succinct, kind, practical, and guide the user naturally—like a coach helping them prepare, not like grading them.

If relevant, gently suggest details they might gather (like price comparisons, emotional impacts, credibility examples).
`;

  fetch('http://localhost:5506/api/chatgpt', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ prompt })
  })
    .then(res => res.json())
    .then(data => {
      suggestionDiv.textContent = data.response || 'Unable to fetch coach suggestion.';
    })
    .catch(err => {
      suggestionDiv.textContent = 'Coach unavailable at the moment.';
      console.error(err);
    });
}

  
  function generateStyleFeedback(chosen, correctStyle, isCorrect) {
    // Show loading in feedback area
    styleGuessFeedback.style.display = 'block';
    feedbackTitle.textContent = isCorrect ? 'Correct!' : 'Not Quite';
    feedbackContent.textContent = 'Analyzing style characteristics...';
    
    // Generate detailed feedback through API
    const prompt = `
You are CommuniCoach, an expert communication coach.

CONVERSATION CONTEXT:
- The user is learning about different communication styles
- They were shown this statement: "${exerciseState.rounds[roundIndex].partnerParagraph}"
- The statement was written in ${correctStyle} style
- The user guessed it was in ${chosen} style
- Their guess was ${isCorrect ? 'correct' : 'incorrect'}

TASK:
Give brief feedback (2-3 sentences) explaining why this statement is an example of ${correctStyle} style.
Point out 1-2 specific characteristics or phrases in the statement that exemplify this style.
${!isCorrect ? `Briefly explain how this differs from ${chosen} style.` : ''}

IMPORTANT:
- Keep your response concise and educational
- Focus on specific language features in the statement
- Be conversational and encouraging
`;

    fetch('http://localhost:5506/api/chatgpt', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ prompt })
    })
    .then(response => response.json())
    .then(data => {
      if (data.error) throw new Error(data.error);
      
      // Update feedback content
      feedbackContent.textContent = data.response.trim();
      
      // Store feedback in state
      exerciseState.rounds[roundIndex].styleFeedback = data.response.trim();
    })
    .catch(err => {
      console.error('Feedback generation error:', err);
      feedbackContent.textContent = isCorrect ? 
        `That's correct! This is a clear example of ${correctStyle} communication.` :
        `This statement actually demonstrates ${correctStyle} communication, not ${chosen}.`;
    });
  }

  function renderResponseStyleButtons() {
    responseStyleRow.innerHTML = '';
    
    // Get a subset of styles for selection - include the correct answer from previous section
    const correctStyle = exerciseState.rounds[roundIndex].correctStyle;
    const allStyles = exerciseState.styleSubset;
    
    // Choose 3 additional random styles (different from correct style)
    const otherStyles = allStyles.filter(s => s !== correctStyle);
    shuffleArray(otherStyles);
    const styleOptions = [correctStyle, ...otherStyles.slice(0, 3)];
    
    // Shuffle final array for display
    shuffleArray(styleOptions);
    
    styleOptions.forEach(st => {
      const btn = document.createElement('button');
      btn.className = 'response-style-button';
      btn.textContent = st;
      btn.addEventListener('click', () => handleUserResponseStyle(st, btn));
      responseStyleRow.appendChild(btn);
    });
  }
  
  function handleUserResponseStyle(selectedStyle, btn) {
    // Highlight selected button
    responseStyleRow.querySelectorAll('button').forEach(b => {
      b.classList.remove('selected');
    });
    btn.classList.add('selected');

    // Store user's selected style
    exerciseState.rounds[roundIndex].userResponseStyle = selectedStyle;

    const userText = userResponseEl.value.trim();
    if (!userText) {
      coachFeedback.style.display = 'none';
      return;
    }
    
    // Store user's response text
    exerciseState.rounds[roundIndex].userResponseText = userText;
    
    // Generate feedback on response style
    generateResponseFeedback(userText, selectedStyle);
    
    // Enable next button once user has selected a style
    nextRoundBtn.disabled = false;
  }
  
  function generateResponseFeedback(userText, selectedStyle) {
    // Show loading in feedback area
    coachFeedback.style.display = 'block';
    responseFeedbackContent.textContent = 'Analyzing your response...';
    
    const prompt = `
You are CommuniCoach, a communication styles expert.

CONVERSATION CONTEXT:
- User is practicing different communication styles
- They're responding to: "${exerciseState.rounds[roundIndex].partnerParagraph}"
- Their response: "${userText}"
- They labeled their response as using a "${selectedStyle}" communication style

TASK:
Analyze whether their response matches their chosen style label.
1. Identify if they accurately characterized their style (be honest but supportive)
2. Point out 1-2 specific phrases or elements that support or contradict their style choice
3. If their response better matches a different style, briefly suggest what style it actually demonstrates
4. Provide one quick tip to strengthen the ${selectedStyle} style in their response

Keep your response under 3 sentences. Be specific and constructive.
`;

    fetch('http://localhost:5506/api/chatgpt', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ prompt })
    })
    .then(response => response.json())
    .then(data => {
      if (data.error) throw new Error(data.error);
      
      // Update feedback content
      responseFeedbackContent.textContent = data.response.trim();
      
      // Store feedback in state
      exerciseState.rounds[roundIndex].responseFeedback = data.response.trim();
    })
    .catch(err => {
      console.error('Response feedback error:', err);
      responseFeedbackContent.textContent = `I can see elements of ${selectedStyle} style in your response. To strengthen this style further, consider being more explicit with your language choices.`;
    });
  }
  function formatHistory() {
  return state.conversationHistory
    .map((entry, i) => `${i + 1}. ${entry.speaker} (${entry.type || 'neutral'}): "${entry.message}"`)
    .join('\n');
}

  
  function handleGenerateResponse() {
    // Disable button during generation
    generateResponseBtn.disabled = true;
    generateResponseBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Generating...';
    
    // Get current round data
    const partnerMessage = exerciseState.rounds[roundIndex].partnerParagraph;
    const correctStyle = exerciseState.rounds[roundIndex].correctStyle;
    
    // Determine which style to use for the response
    // Pick a random style from user's selected styles
    const allStyles = exerciseState.styleSubset;
    const responseStyle = allStyles[Math.floor(Math.random() * allStyles.length)];
    
    const prompt = `
You are CommuniCoach, helping a user practice communication styles.

CONVERSATION CONTEXT:
- User's scenario: ${exerciseState.scenario}
- User's goal: ${exerciseState.goal}
- Partner just said: "${partnerMessage}" (in ${correctStyle} style)

TASK:
Generate a brief response (2-3 sentences) that the user could give, using the "${responseStyle}" communication style.

CHARACTERISTICS OF ${responseStyle.toUpperCase()} STYLE:
${getStyleCharacteristics(responseStyle)}

Write ONLY the response, nothing else. Do not label the style in your response.
`;

    fetch('http://localhost:5506/api/chatgpt', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ prompt })
    })
    .then(response => response.json())
    .then(data => {
      if (data.error) throw new Error(data.error);
      
      // Insert generated response in the textarea
      userResponseEl.value = data.response.trim();
      suggestionDiv.classList.add('loading');
suggestionDiv.textContent = 'Processing...';


  })

  
    // Highlight the corresponding style button if it exists
    // const styleBtn = Array.from(responseStyleRow.querySelectorAll('button'))
    //   .find(btn => btn.textContent === responseStyle);
    
    // if (styleBtn) {
    //   styleBtn.click(); // Trigger the style selection
    // }
   
    .catch(err => {


      
      showToast(`Generating a response`);
    })
    .catch(err => {
      console.error('Response generation error:', err);
      showToast('Error generating response', 2000, true);
    })
    .finally(() => {
      // Re-enable button
      generateResponseBtn.disabled = false;
      generateResponseBtn.innerHTML = '<i class="fa-solid fa-magic"></i> Generate Response';
    });
  }

  // Speech
  function initSpeechRecognition(){
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SR) {
      console.warn("Speech Recognition not supported");
      return;
    }
    
    recognition = new SR();
    recognition.continuous = false;
    recognition.interimResults = true;
    recognition.lang = 'en-US';

    recognition.onstart = () => {
      isListening = true;
      responseMicBtn.classList.add('listening');
      micStatusText.textContent = 'Listening...';
    };
    
    recognition.onerror = (evt) => {
      console.error('Speech rec error:', evt.error);
      showToast('Mic error: ' + evt.error, 2000, true);
      isListening = false;
      responseMicBtn.classList.remove('listening');
      micStatusText.textContent = 'Click to speak';
    };
    
    recognition.onend = () => {
      isListening = false;
      responseMicBtn.classList.remove('listening');
      micStatusText.textContent = 'Click to speak';
    };
    
    recognition.onresult = (evt) => {
      let finalText = '';
      let interimText = '';
      
      for (let i = evt.resultIndex; i < evt.results.length; i++) {
        const transcript = evt.results[i][0].transcript;
        if (evt.results[i].isFinal) {
          finalText += transcript;
        } else {
          interimText += transcript;
        }
      }
      
      // Update text area with final results
      if (finalText) {
        userResponseEl.value += finalText + ' ';
      }
      // Show interim results
      else if (interimText) {
        // Could show interim results in UI if desired
      }
    };
  }

  function toggleMic() {
    if (!recognition) {
      showToast('Speech recognition not supported in this browser', 2000, true);
      return;
    }
    
    if (isListening) {
      recognition.stop();
    } else {
      try {
        // Clear any previous transcription timeout
        if (recognitionTimeout) {
          clearTimeout(recognitionTimeout);
          recognitionTimeout = null;
        }
        
        recognition.start();
        
        // Set a longer timeout (30 seconds) to prevent cutoff
        recognitionTimeout = setTimeout(() => {
          if (isListening) {
            recognition.stop();
            showToast('Listening stopped automatically after 30 seconds.');
          }
        }, 90000);
      } catch (e) {
        console.error('mic start error:', e);
        showToast('Mic error: ' + e.message, 2000, true);
      }
    }
  }

  // Round Nav
  function handleNextRound() {
    // Store current user inputs if not already stored
    const userText = userResponseEl.value.trim();
    const userStyle = exerciseState.rounds[roundIndex].userResponseStyle;
    
    if (userText && !exerciseState.rounds[roundIndex].userResponseText) {
      exerciseState.rounds[roundIndex].userResponseText = userText;
    }
    
    if (roundIndex < 4) {
      startRound(roundIndex + 1);
      setProgress(20 + (roundIndex + 1) * 15);
    } else {
      finishExercise();
    }
  }
  
  function handlePrevRound() {
    if (roundIndex > 0) {
      startRound(roundIndex - 1);
      setProgress(20 + (roundIndex - 1) * 15);
    }
  }

  function finishExercise() {
    exerciseSection.style.display = 'none';
    summarySection.style.display = 'block';
    setProgress(100);
    
    // Generate structured summary
    generateSummary()
      .then(summaryData => {
        // Populate summary sections
        overallPerformance.innerHTML = summaryData.overall;
        recognitionStrengths.innerHTML = formatStrengthsList(summaryData.recognitionStrengths);
        expressionStrengths.innerHTML = formatStrengthsList(summaryData.expressionStrengths);
        growthOpportunities.innerHTML = formatGrowthList(summaryData.growthOpportunities);
        practicalTips.innerHTML = summaryData.practicalTips;
      })
      .catch(e => {
        console.error('Error generating summary:', e);
        
        // Fallback content
        overallPerformance.textContent = 'You completed 5 rounds of style awareness practice.';
        recognitionStrengths.textContent = 'You demonstrated ability to identify different communication styles.';
        expressionStrengths.textContent = 'You practiced expressing yourself in various styles.';
        growthOpportunities.textContent = 'Continue practicing to distinguish between similar styles.';
        practicalTips.textContent = 'Review the characteristics of each style and practice using them in your daily communications.';
      });
  }
  
  function formatStrengthsList(strengths) {
    if (!strengths || !Array.isArray(strengths) || strengths.length === 0) {
      return 'No specific strengths identified.';
    }
    
    return strengths.map(strength => 
      `<div class="strength-item">${strength}</div>`
    ).join('');
  }
  
  function formatGrowthList(opportunities) {
    if (!opportunities || !Array.isArray(opportunities) || opportunities.length === 0) {
      return 'No specific growth opportunities identified.';
    }
    
    return opportunities.map(opportunity => 
      `<div class="growth-item">${opportunity}</div>`
    ).join('');
  }
  
  async function generateSummary() {
    showToast('Generating your personalized insights...');
    
    // Format rounds data for the prompt
    const roundsData = exerciseState.rounds.map((r, i) => {
      return `
Round ${i + 1}:
- Partner statement (${r.correctStyle} style): "${r.partnerParagraph}"
- User's style guess: ${r.userStyleGuess || 'Not completed'}
- User's response: "${r.userResponseText || 'Not provided'}"
- User's style label: ${r.userResponseStyle || 'Not selected'}
`;
    }).join('\n');
    
    const prompt = `
You are CommuniCoach, a communication styles expert providing personalized feedback after a 5-round style awareness exercise.

EXERCISE CONTEXT:
- User's scenario: ${exerciseState.scenario}
- User's goal: ${exerciseState.goal}
- Styles practiced: ${exerciseState.styleSubset.join(', ')}

EXERCISE RESULTS:
${roundsData}

TASK:
Provide a structured summary of the user's performance with these EXACT sections:

1. OVERALL: A brief 2-3 sentence overview of their performance and key insights.

2. RECOGNITION STRENGTHS: List 2-3 specific strengths in how they recognized communication styles. Format as an array of distinct points.

3. EXPRESSION STRENGTHS: List 2-3 specific strengths in how they expressed different communication styles. Format as an array of distinct points.

4. GROWTH OPPORTUNITIES: List 2-3 specific ways they could improve their style awareness. Format as an array of growth suggestions.

5. PRACTICAL TIPS: 2-3 sentences with practical advice they can apply immediately to improve their communication style awareness.

FORMAT YOUR RESPONSE AS A JSON OBJECT with these exact keys:
{
  "overall": "text here",
  "recognitionStrengths": ["point 1", "point 2", "point 3"],
  "expressionStrengths": ["point 1", "point 2", "point 3"],
  "growthOpportunities": ["point 1", "point 2", "point 3"],
  "practicalTips": "text here"
}
`;

    try {
      const resp = await fetch('http://localhost:5506/api/chatgpt', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ prompt })
      });
      
      if (!resp.ok) throw new Error('HTTP ' + resp.status);
      
      const data = await resp.json();
      
      // Parse the JSON response
      try {
        return JSON.parse(data.response.trim());
      } catch (parseError) {
        console.error('Error parsing summary JSON:', parseError);
        
        // If JSON parsing fails, try to extract sections manually
        const rawText = data.response.trim();
        return {
          overall: extractSection(rawText, 'OVERALL') || 'You completed the style awareness exercise.',
          recognitionStrengths: [
            extractSection(rawText, 'RECOGNITION STRENGTHS') || 'You practiced identifying different communication styles.'
          ],
          expressionStrengths: [
            extractSection(rawText, 'EXPRESSION STRENGTHS') || 'You practiced expressing yourself in various styles.'
          ],
          growthOpportunities: [
            extractSection(rawText, 'GROWTH OPPORTUNITIES') || 'Continue practicing to distinguish between similar styles.'
          ],
          practicalTips: extractSection(rawText, 'PRACTICAL TIPS') || 'Pay attention to the specific language patterns that define each communication style.'
        };
      }
    } catch (e) {
      console.error('Summary generation error:', e);
      return {
        overall: 'You completed all 5 rounds of the style awareness exercise, practicing both recognition and expression of different communication styles.',
        recognitionStrengths: [
          'You successfully identified various communication styles in conversation.',
          'You gained practice distinguishing between similar-seeming styles.',
          'You developed awareness of style characteristics in real dialogue.'
        ],
        expressionStrengths: [
          'You practiced adapting your communication style intentionally.',
          'You experienced how different styles can achieve different outcomes.',
          'You developed flexibility in your communication approach.'
        ],
        growthOpportunities: [
          'Continue practicing identifying subtle style differences.',
          'Experiment with styles that feel less natural to you.',
          'Practice adapting your style based on your conversation partner.'
        ],
        practicalTips: 'Start noticing the communication styles of people around you in daily life. When preparing for important conversations, consider which style would be most effective for your goals.'
      };
    }
  }
  
  function extractSection(text, sectionName) {
    const regex = new RegExp(`${sectionName}:\\s*(.+?)(?=\\w+:|$)`, 'is');
    const match = text.match(regex);
    return match ? match[1].trim() : null;
  }

  // Utility
  function setProgress(percent) {
    progressBar.style.width = percent + '%';
  }
  
  function shuffleArray(arr) {
    for (let i = arr.length - 1; i > 0; i--) {
      let j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
  }

  let toastCount = 0;
  function showToast(msg, duration = 2000, isError = false) {
    toastCount++;
    const tid = 'toast-' + toastCount;
    const el = document.createElement('div');
    el.className = 'toast';
    if (isError) el.classList.add('error');
    el.id = tid;
    el.textContent = msg;
    document.body.appendChild(el);
    setTimeout(() => hideToast(tid), duration);
    return tid;
  }
  
  function hideToast(id) {
    const el = document.getElementById(id);
    if (el) el.remove();
  }
  </script>
</body>
</html>
