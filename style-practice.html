<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Style Practice Exercise - CommuniCoach</title>

  <!-- Fonts + Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />

  <!-- Main CSS -->
  <style>
    /* ====== COLORS & THEMES ====== */
    :root {
      --primary-color: #2d4a3e;
      --secondary-color: #1b4072;
      --accent-color: #a1ce3e;
      --highlight-color: #dcefc6;
      --energy-color: #74b49b;
      --error-color: #ff6b6b;
      --shadow-color: rgba(45, 74, 62, 0.15);
      --bg-color: #ffffff;
      --bg-secondary: #f9fef3;
      --bg-card: #ffffff;
      --text-primary: #2d4a3e;
      --text-secondary: #555;
      --text-light: #ffffff;

      --user-bubble-bg: #e8f4f8;
      --partner-bubble-bg: #f0f0f0;
      --coach-bubble-bg: #dcefc6;

      --positive-color: #4caf50;
      --warning-color: #ff9800;
      --negative-color: #f44336;

      --gradient-bg: linear-gradient(
        135deg,
        rgba(45, 74, 62, 0.05),
        rgba(161, 206, 62, 0.07)
      );
      --border-color: #e0e0e0;
      --input-bg: #ffffff;
      --footer-bg: url(".vscode/Images/situationfooter.png");
      --progress-bg: #e0e0e0;
      --progress-fill: #136f6f;
    }
    

    [data-theme="dark"] {
      --primary-color: #78a891;
      --secondary-color: #60a3d9;
      --highlight-color: #314a2e;
      --shadow-color: rgba(0, 0, 0, 0.25);

      --bg-color: #121212;
      --bg-secondary: #1e1e1e;
      --bg-card: #242424;

      --text-primary: #e0e0e0;
      --text-secondary: #aaaaaa;

      --user-bubble-bg: #2d4a3e;
      --partner-bubble-bg: #333333;
      --coach-bubble-bg: #314a2e;

      --gradient-bg: linear-gradient(
        135deg,
        rgba(45, 74, 62, 0.15),
        rgba(161, 206, 62, 0.17)
      );
      --border-color: #444444;
      --input-bg: #333333;

      --progress-bg: #444444;
      --progress-fill: #78c7ba;
    }

    /* ====== GLOBAL STYLES ====== */
    html, body {
      margin: 0;
      padding: 0;
      font-family: "Poppins", sans-serif;
      background-color: var(--bg-color);
      color: var(--text-primary);
      transition: background-color 0.3s, color 0.3s;
    }
    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background: var(--bg-secondary);
      opacity: 0.8;
      z-index: -1;
    }

    /* Header and Navigation */
    .header-wrapper {
      position: fixed;
      top: 0;
      width: 100%;
      background: var(--bg-card);
      backdrop-filter: blur(10px);
      z-index: 1000;
      box-shadow: 0 2px 20px var(--shadow-color);
    }

    .top-nav {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 20px;
      padding: 15px 0;
      color: var(--text-primary);
      position: relative;
    }

    .top-nav a {
      color: var(--text-primary);
      text-decoration: none;
      padding: 5px 10px;
      border-radius: 20px;
      transition: all 0.3s ease;
    }

    .logo {
      position: absolute;
      left: 20px;
    }

    .logo img {
      height: 40px;
    }

    .top-nav a:hover {
      background: var(--highlight-color);
    }

    .top-nav a.current {
      background: #136f6f;
      color: var(--text-light);
    }

    /* Progress Bar */
    .progress-bar-container {
      width: 100%;
      padding: 10px 0;
      background: var(--bg-secondary);
    }

    .progress-bar {
      width: 80%;
      margin: 0 auto;
      height: 8px;
      background: var(--progress-bg);
      border-radius: 4px;
      overflow: hidden;
    }

    .progress-bar .progress {
      width: 80%; /* Will be updated via JS */
      height: 100%;
      background: var(--progress-fill);
      border-radius: 4px;
      transition: width 0.5s ease;
    }

    /* Dark Mode Toggle */
    .dark-mode-toggle {
      position: absolute;
      right: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .toggle-label {
      font-size: 0.9rem;
      color: var(--text-primary);
    }

    .switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 24px;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 16px;
      width: 16px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
    }

    input:checked + .slider {
      background-color: var(--accent-color);
    }

    input:checked + .slider:before {
      transform: translateX(26px);
    }

    .slider.round {
      border-radius: 34px;
    }

    .slider.round:before {
      border-radius: 50%;
    }

    /* Mobile Menu */
    .mobile-menu-button {
      display: none;
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--text-primary);
      position: absolute;
      right: 20px;
      top: 15px;
    }

    /* ====== HERO SECTION ====== */
    .hero-section {
      margin-top: 100px;
      padding: 4rem 0;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 2rem;
      position: relative;
    }
    .hero-content {
      display: flex;
      align-items: center;
      gap: 4rem;
    }
    .hero-text {
      flex: 1.2;
    }
    .hero-image {
      flex: 1;
    }
    .hero-image img {
      width: 100%;
      border-radius: 15px;
      box-shadow: 0 4px 20px var(--shadow-color);
    }
    .content-card {
      background-color: var(--highlight-color);
      padding: 2.5rem;
      border-radius: 15px;
      box-shadow: 0 4px 15px var(--shadow-color);
      position: relative;
      overflow: hidden;
    }
    .section-icon {
      color: #ff221f;
      font-size: 2rem;
      margin-bottom: 1rem;
      display: block;
      text-align: center;
    }
    .hero-text h1 {
      font-size: 1.75em;
      margin-bottom: 20px;
      font-weight: 600;
    }

    /* ====== SITUATION & GOAL ====== */
    .situation-review-section {
      padding: 2rem 0;
    }
    .situation-card {
      background: var(--bg-card);
      border-radius: 15px;
      padding: 2rem;
      box-shadow: 0 4px 20px var(--shadow-color);
      margin-bottom: 2rem;
    }
    .situation-card h2 {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 1.4em;
      margin-bottom: 1.5rem;
    }
    .situation-content {
      padding: 1.5rem;
      border: 2px solid var(--accent-color);
      border-radius: 10px;
      background: var(--highlight-color);
      margin-bottom: 1.5rem;
    }
    .goal-summary {
      background: var(--bg-secondary);
      border-radius: 10px;
      padding: 1rem;
      border-left: 4px solid var(--accent-color);
    }

    /* ====== EXERCISE SETUP ====== */
    .exercise-setup-section {
      padding: 2rem 0;
    }
    .setup-card {
      background: var(--bg-card);
      border-radius: 15px;
      padding: 2rem;
      box-shadow: 0 4px 20px var(--shadow-color);
    }
    .form-group {
      margin-bottom: 1.5rem;
    }
    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      color: var(--text-primary);
    }
    .form-group input,
    .form-group select {
      width: 100%;
      padding: 0.8rem;
      border: 2px solid var(--border-color);
      border-radius: 10px;
      font-family: "Poppins", sans-serif;
      font-size: 1em;
      background: var(--input-bg);
      color: var(--text-primary);
      transition: 0.3s;
    }
    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: var(--accent-color);
      box-shadow: 0 0 0 3px rgba(161, 206, 62, 0.2);
    }
    .form-actions {
      display: flex;
      justify-content: flex-end;
      margin-top: 2rem;
    }

    /* Styles Selection */
    .styles-category-heading {
      margin-top: 1.5rem;
      margin-bottom: 0.5rem;
      font-weight: 500;
      color: var(--text-primary);
      font-size: 1em;
      background: var(--highlight-color);
      padding: 0.5rem;
      border-radius: 8px;
    }
    
    .styles-choices {
      display: flex;
      flex-wrap: wrap;
      gap: 0.7rem;
      margin-bottom: 1rem;
    }
    
    .style-checkbox {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 20px;
      padding: 0.5rem 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .style-checkbox:hover {
      background: var(--highlight-color);
      border-color: var(--accent-color);
    }
    
    .style-checkbox.selected {
      background: var(--highlight-color);
      border-color: var(--accent-color);
    }
    
    .validation-message {
      color: var(--error-color);
      font-size: 0.9em;
      margin-top: 0.5rem;
      display: none;
    }

    /* ====== PRACTICE EXERCISE SECTION ====== */
    .practice-exercise-section {
      padding: 2rem 0;
      display: none;
    }

    .conversation-card {
      background: var(--bg-card);
      border-radius: 15px;
      padding: 2rem;
      box-shadow: 0 4px 20px var(--shadow-color);
      margin-bottom: 2rem;
    }

    .conversation-card h2 {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 1.4em;
      margin-bottom: 1.5rem;
    }

    .conversation-display {
      max-height: 600px;
      overflow-y: auto;
      margin-bottom: 1.5rem;
      padding: 1rem;
      border-radius: 10px;
      background: var(--bg-secondary);
    }

    .round-indicator {
      text-align: right;
      font-size: 0.9em;
      color: var(--text-secondary);
      margin-bottom: 1rem;
    }

    .message {
      margin-bottom: 1.2rem;
      position: relative;
    }

    .message-bubble {
      max-width: 80%;
      padding: 1rem;
      border-radius: 15px;
      position: relative;
    }

    .message.user .message-bubble {
      background: var(--user-bubble-bg);
      margin-left: auto;
      border-bottom-right-radius: 4px;
    }

    .message.partner .message-bubble {
      background: var(--partner-bubble-bg);
      margin-right: auto;
      border-bottom-left-radius: 4px;
    }

    .message.coach .message-bubble {
      background: var(--coach-bubble-bg);
      margin-right: auto;
      border-bottom-left-radius: 4px;
      border-left: 4px solid var(--accent-color);
    }

    .message-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 0.5rem;
      font-size: 0.9rem;
      color: var(--text-secondary);
    }

    .message-header .style-badge {
      font-size: 0.8em;
      padding: 0.2rem 0.5rem;
      border-radius: 10px;
      background: rgba(0, 0, 0, 0.1);
      color: var(--text-primary);
    }

    /* Style Buttons Row */
    .style-options-container {
      margin-top: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .style-options-title {
      font-size: 1em;
      margin-bottom: 0.8rem;
      color: var(--text-primary);
    }

    .style-options {
      display: flex;
      flex-wrap: wrap;
      gap: 0.7rem;
      margin-bottom: 1rem;
    }

    .style-button {
      padding: 0.6rem 1rem;
      border: 2px solid var(--border-color);
      border-radius: 10px;
      background: var(--bg-secondary);
      color: var(--text-primary);
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .style-button:hover {
      transform: translateY(-3px);
      border-color: var(--accent-color);
      background: var(--highlight-color);
    }

    .style-button.selected {
      border-color: var(--accent-color);
      background: var(--highlight-color);
    }

    /* Response Input Area */
    .response-section {
      margin-top: 1.5rem;
    }

    .response-section label {
      display: block;
      margin-bottom: 0.5rem;
      color: var(--text-primary);
      font-weight: 500;
    }

    .mic-row {
      display: flex;
      gap: 1rem;
      align-items: center;
      margin-bottom: 1rem;
    }

    .mic-button {
      width: 50px;
      height: 50px;
      border: none;
      border-radius: 50%;
      background: var(--accent-color);
      color: white;
      font-size: 1.2rem;
      cursor: pointer;
      box-shadow: 0 2px 10px var(--shadow-color);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    .mic-button:hover {
      transform: scale(1.05);
      background: var(--energy-color);
    }

    .mic-button.listening {
      background: var(--error-color);
      animation: pulseMic 1.2s infinite;
    }

    @keyframes pulseMic {
      0% { box-shadow: 0 0 0 0 rgba(255, 107, 107, 0.4); }
      70% { box-shadow: 0 0 0 10px rgba(255, 107, 107, 0); }
      100% { box-shadow: 0 0 0 0 rgba(255, 107, 107, 0); }
    }

    .response-input {
      width: 100%;
      padding: 0.8rem;
      min-height: 100px;
      border: 2px solid var(--border-color);
      border-radius: 10px;
      background: var(--input-bg);
      color: var(--text-primary);
      margin-bottom: 1rem;
      font-family: "Poppins", sans-serif;
      resize: vertical;
    }

    .response-input:focus {
      outline: none;
      border-color: var(--accent-color);
      box-shadow: 0 0 0 3px rgba(161, 206, 62, 0.2);
    }

    .response-actions {
      display: flex;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .generate-response-btn {
      padding: 0.7rem 1.5rem;
      border: 2px solid var(--primary-color);
      border-radius: 25px;
      background: none;
      color: var(--primary-color);
      font-family: "Poppins", sans-serif;
      font-size: 0.9rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      transition: all 0.3s ease;
    }

    .generate-response-btn:hover {
      background: var(--highlight-color);
      transform: translateY(-2px);
    }

    .preview-response {
      padding: 1rem;
      background: var(--bg-secondary);
      border-radius: 10px;
      margin-bottom: 1.5rem;
      border-left: 4px solid var(--accent-color);
      display: none;
    }

    .preview-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 0.5rem;
      font-size: 0.9rem;
    }

    .preview-content {
      font-size: 1em;
      color: var(--text-primary);
    }

    .navigation-actions {
      display: flex;
      justify-content: space-between;
      margin-top: 1.5rem;
    }

    /* ====== INSIGHTS SECTION ====== */
    .insights-section {
      padding: 2rem 0;
      display: none;
    }

    .insights-card {
      background: var(--bg-card);
      border-radius: 15px;
      padding: 2rem;
      box-shadow: 0 4px 20px var(--shadow-color);
      margin-bottom: 2rem;
    }

    .insights-title {
      display: flex;
      align-items: center;
      gap: 0.8rem;
      font-size: 1.4em;
      margin-bottom: 1.5rem;
      color: var(--text-primary);
    }

    .insights-title i {
      color: var(--accent-color);
    }

    .insights-container {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1.5rem;
    }

    .insight-item {
      background: var(--bg-secondary);
      border-radius: 10px;
      padding: 1.5rem;
      border-left: 4px solid var(--accent-color);
    }

    .textContent 
    .style-tag {
      display: inline-block;
      background: var(--highlight-color);
      color: var(--primary-color);
      padding: 0.3rem 0.8rem;
      margin: 0.3rem;
      border-radius: 20px;
      font-size: 0.9rem;
      border: 1px solid var(--accent-color);
    }

    .insight-item h3 {
      display: flex;
      align-items: center;
      gap: 0.8rem;
      font-size: 1.2em;
      margin-bottom: 1rem;
      color: var(--text-primary);
    }

    .insight-item h3 i {
      color: var(--secondary-color);
    }

    .insight-content {
      color: var(--text-secondary);
      font-size: 0.95em;
      line-height: 1.6;
    }

    .insight-content ul {
      padding-left: 1.5rem;
      margin-top: 0.8rem;
    }

    .insight-content li {
      margin-bottom: 0.5rem;
    }

    .insight-quote {
      margin: 1rem 0;
      padding: 1rem;
      background: var(--bg-card);
      border-radius: 10px;
      border-left: 3px solid var(--secondary-color);
      font-style: italic;
      color: var(--text-primary);
    }

    .insight-actions {
      display: flex;
      justify-content: space-between;
      margin-top: 2rem;
      gap: 1rem;
    }

    /* ====== BUTTONS & CONTROLS ====== */
    .btn {
      padding: 0.8rem 1.5rem;
      border-radius: 30px;
      font-family: "Poppins", sans-serif;
      font-size: 1rem;
      cursor: pointer;
      transition: 0.3s;
      border: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }
    
    .btn-primary {
      background: var(--primary-color);
      color: white;
      box-shadow: 0 4px 15px var(--shadow-color);
    }
    
    .btn-primary:hover {
      transform: translateY(-3px);
      background: var(--secondary-color);
      box-shadow: 0 8px 25px var(--shadow-color);
    }
    
    .btn-outline {
      background: transparent;
      color: var(--primary-color);
      border: 2px solid var(--primary-color);
    }
    
    .btn-outline:hover {
      background: var(--highlight-color);
      transform: translateY(-3px);
    }
    
    .btn-accent {
      background: var(--accent-color);
      color: white;
    }
    
    .btn-accent:hover {
      background: var(--energy-color);
    }
    
    .btn.disabled, .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      pointer-events: none;
    }
    
    .btn .spinner {
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s linear infinite;
      margin-right: 0.5rem;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* ====== FOOTER ====== */
    .footer-nav {
      width: 100%;
      margin-top: auto;
      color: #ffffff;
      background: var(--footer-bg) no-repeat center center;
      background-size: cover;
      min-height: 60px;
      padding: 15px 0;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 20px;
    }
    .footer-nav p {
      margin: 0;
    }
    .footer-nav a {
      color: white;
      text-decoration: none;
      transition: opacity 0.3s;
    }
    .footer-nav a:hover {
      opacity: 0.8;
    }

    /* ====== TOAST & NOTIFICATIONS ====== */
    .toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--primary-color);
      color: white;
      padding: 12px 24px;
      border-radius: 30px;
      z-index: 1000;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      animation: fadeInUp 0.3s ease;
    }
    .toast.error {
      background: var(--error-color);
    }
    @keyframes fadeInUp {
      from { opacity: 0; transform: translate(-50%, 20px); }
      to { opacity: 1; transform: translate(-50%, 0); }
    }

    /* ====== RESPONSIVE BREAKPOINTS ====== */
    @media (max-width: 768px) {
      .hero-content {
        flex-direction: column-reverse;
        gap: 2rem;
        text-align: center;
      }
      .hero-text h1 {
        font-size: 1.6em;
      }
      .hero-text p {
        font-size: 0.95em;
      }
      .nav-links {
        display: none;
        width: 100%;
        flex-direction: column;
        gap: 10px;
        text-align: center;
        padding-top: 10px;
      }
      .nav-links.active {
        display: flex;
      }
      .logo {
        position: static;
        margin-bottom: 10px;
      }
      .mobile-menu-button {
        display: block;
      }
      .dark-mode-toggle {
        position: static;
        margin-top: 10px;
        justify-content: center;
      }
      .style-options {
        flex-direction: column;
      }
      .navigation-actions {
        flex-direction: column;
        gap: 1rem;
      }
      .response-actions {
        flex-direction: column;
      }
      .btn {
        width: 100%;
      }
      .container {
        padding: 0 1rem;
      }
    }

    @media (max-width: 480px) {
      .container {
        padding: 0 1rem;
      }
      .mic-row {
        flex-direction: column;
        align-items: flex-start;
      }
      .style-button {
        width: 100%;
      }
    }

    /* ====== ANIMATIONS ====== */
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .fade-in {
      opacity: 0;
      animation: fadeIn 0.8s ease forwards;
    }
    .delay-1 {
      animation-delay: 0.2s;
    }
    .delay-2 {
      animation-delay: 0.4s;
    }
  </style>
</head>
<body>
  <!-- Header / Nav / Dark Mode -->
  <div class="header-wrapper">
    <div class="top-nav">
      <a href="#" class="logo"><img src=".vscode/Images/CClogo.png" alt="CommuniCoach"></a>
      <button class="mobile-menu-button" onclick="toggleMenu()">☰</button>
      <div class="nav-links" id="navLinks">
        <a href="welcome.html">Welcome</a>
        <a href="tone-selection.html">Tone Selection</a>
        <a href="situation-room.html">Situation Room</a>
        <a href="refined-narrative.html">Refined Narrative</a>
        <a href="action-arena.html">Action Arena</a>
        <a href="style-practice-exercise.html" class="current">Style Practice</a>
      </div>
      <!-- Dark Mode Toggle -->
      <div class="dark-mode-toggle">
        <span class="toggle-label">Dark Mode</span>
        <label class="switch">
          <input type="checkbox" id="darkModeToggle" />
          <span class="slider round"></span>
        </label>
      </div>
    </div>
    <div class="progress-bar-container">
      <div class="progress-bar">
        <div class="progress"></div>
      </div>
    </div>
  </div>
  
  <!-- Hero Section -->
  <section class="hero-section">
    <div class="container hero-content">
      <div class="hero-text fade-in">
        <div class="content-card">
          <i class="fa-solid fa-comments section-icon"></i>
          <h1>Style Practice Exercise</h1>
          <p>
            Master effective communication by practicing different styles and observing their impact on conversations.
            This exercise will help you transform the same message into various communication styles and see how each
            affects your conversation partner's response.
          </p>
          <p>
            Learn when to maintain your natural style and when to adapt for better outcomes. Explore how your style choices
            influence the emotional tenor and results of your interactions.
          </p>
        </div>
      </div>
      <div class="hero-image fade-in delay-1">
        <img src=".vscode/Images/conversation.png" alt="Style Practice Exercise" />
      </div>
    </div>
  </section>

  <!-- Situation + Goal -->
  <section class="situation-review-section">
    <div class="container">
      <div class="situation-card fade-in delay-1">
        <h2><i class="fa-solid fa-file-lines"></i> Your Current Situation</h2>
        <div class="situation-content" id="situationSummary">
          <!-- from localStorage -->
        </div>
        <div class="goal-summary">
          <p><strong>Your Communication Goal:</strong> 
            <span id="goalSummary"></span>
          </p>
        </div>
      </div>
    </div>
  </section>

  <!-- Setup Section -->
  <section class="exercise-setup-section" id="exerciseSetupSection">
    <div class="container">
      <div class="setup-card fade-in delay-2">
        <h2>Set the Stage for Style Practice</h2>
        <p>Define who you'll be speaking with and choose the communication styles you want to practice using in this conversation.</p>
        
        <form id="setupForm">
          <div class="form-group">
            <label for="conversationPartner">Who will you be speaking with?</label>
            <input type="text" id="conversationPartner" placeholder="e.g. Sarah (your manager)" />
          </div>
          
          <div class="form-group">
            <label for="conversationMedium">Conversation Medium</label>
            <select id="conversationMedium">
              <option value="">Select a medium...</option>
              <option value="face-to-face">Face-to-face</option>
              <option value="video-call">Video call</option>
              <option value="phone-call">Phone call</option>
              <option value="email">Email</option>
              <option value="text-message">Text message</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="partnerOpeningStyle">Partner's Opening Style</label>
            <select id="partnerOpeningStyle">
              <option value="">Select a style...</option>
             
            </select>
          </div>
          
          <!-- Styles Selection -->
          <p>
            Choose at least 6 communication styles you'd like to practice (select at least 2 from each category):
          </p>
          
          <!-- Productive Styles -->
          <div class="styles-category-heading">Constructive Communication Styles</div>
          <div class="styles-choices" id="productiveStylesContainer">
            <!-- Productive styles will be inserted here -->
          </div>
          
          <!-- Neutral Styles -->
          <div class="styles-category-heading">Situational Communication Styles</div>
          <div class="styles-choices" id="neutralStylesContainer">
            <!-- Neutral styles will be inserted here -->
          </div>
          
          <!-- Counterproductive Styles -->
          <div class="styles-category-heading">Challenging Communication Styles</div>
          <div class="styles-choices" id="counterproductiveStylesContainer">
            <!-- Counterproductive styles will be inserted here -->
          </div>
          
          <div class="validation-message" id="validationMessage">
            Please select at least 2 styles from each category 
          </div>
          
          <div class="form-actions">
            <button type="button" class="btn btn-primary" id="startExerciseBtn">
              <span id="startButtonText">Begin Style Practice</span>
              <span id="startSpinner" class="spinner" style="display: none;"></span>
            </button>
          </div>
        </form>
      </div>
    </div>
  </section>

  <!-- Practice Exercise Section -->
  <section class="practice-exercise-section" id="practiceExerciseSection">
    <div class="container">
      <div class="conversation-card">
        <h2><i class="fa-solid fa-comments"></i> Style Practice Conversation</h2>
        <div class="round-indicator">
          Round <span id="roundNumber">1</span> of 5
        </div>
        
        <!-- Conversation Display -->
        <div class="conversation-display" id="conversationDisplay">
          <!-- Messages will be dynamically added here -->
        </div>
         Speak or type your response below or have your coach generate a response for you. Then instatnly transform your response by choosing any of the communication styles listed below and selecting the "Use This" button. You can try out as many styles as you like. Once your transformed response reflects the style you want to use, click the confirm button and notice how your chosen communication style influences your partner's next response. As the conversation progresses, take note of how different communication styles can influence the overall shape or outcome of the conversation.</div>
        <!-- Style Options -->
        <div class="style-options-container" id="styleOptionsContainer">
          <div class="style-options-title">Speak or type your response below - or ask your coach
          <div class="style-options" id="styleOptions">
            <!-- Style buttons will be dynamically added here -->
          </div>
        </div>
        
        <!-- Response Section -->
        <div class="response-section" id="responseSection">
          <label for="userResponse">Your Response:</label>
          <div class="mic-row">
            <button class="mic-button" id="responseMicBtn">
              <i class="fa-solid fa-microphone"></i>
            </button>
            
            <span id="micStatusText">Click to speak</span>
          </div>
          <textarea class="response-input" id="userResponse" placeholder="Type your response here..."></textarea>
          
          <div class="response-actions">
            <button id="generateResponseBtn" class="generate-response-btn">
              <i class="fa-solid fa-magic"></i> Generate Response
            </button>
            <button id="confirmResponseBtn" class="btn btn-primary">
              Confirm Response
            </button>
          </div>
          
          <div class="preview-response" id="previewResponse">
            <div class="preview-header">
              <span>Preview: <span id="previewStyleName">Style</span></span>
              <button id="usePreviewBtn" class="btn btn-outline btn-sm">Use This</button>
            </div>
            <div class="preview-content" id="previewContent"></div>
          </div>
        </div>
        
        <!-- Navigation Actions -->
        <div class="navigation-actions">
          <button class="btn btn-outline" id="restartBtn">
            <i class="fa-solid fa-rotate"></i> Restart Exercise
          </button>
          <button class="btn btn-primary" id="completeExerciseBtn" disabled>
            Complete & Get Insights
          </button>
        </div>
      </div>
    </div>
  </section>

  <!-- Insights Section -->
  <section class="insights-section" id="insightsSection">
    <div class="container">
      <div class="insights-card">
        <div class="insights-title">
          <i class="fa-solid fa-lightbulb"></i>
          <span>Your Style Practice Insights</span>
        </div>
        
        <div class="insights-container" id="insightsContainer">
          <!-- Insights will be dynamically added here -->
        </div>
        
        <div class="insight-actions">
          <button class="btn btn-outline" id="tryAgainBtn">
            <i class="fa-solid fa-rotate"></i> Try Again
          </button>
          <button class="btn btn-primary" id="returnToArenaBtn">
            <i class="fa-solid fa-arrow-right"></i> Return to Action Arena
          </button>
        </div>
      </div>
    </div>
  </section>
  
  <!-- Footer -->
  <footer class="footer-nav">
    <p>&copy; 2024 CommuniCoach. All rights reserved.</p>
    <a href="#">Privacy Policy</a>
    <a href="#">Terms of Service</a>
  </footer>

  <!-- Templates -->
  <template id="messageBubbleTemplate">
    <div class="message">
      <div class="message-bubble">
        <div class="message-header">
          <span class="message-sender"></span>
          <span class="style-badge"></span>
        </div>
        <div class="message-content"></div>
      </div>
    </div>
  </template>



<!-- ======= JS SCRIPT ======= -->
<script>
  // ===== STATE & CONFIGURATION =====
  const state = {
    isListening: false,
    recognitionTimeout: null,
    
    currentRound: 0,
    maxRounds: 5,
    conversationHistory: [],
    selectedStyles: {
      productive: [],
      neutral: [],
      counterproductive: []
    },
    activeStyles: [],
    partnerName: '',
    medium: '',
    partnerOpeningStyle: '',
    lastPartnerMessage: '',             // new field for automatic responses
    apiEndpoint: 'http://localhost:5506/api/chatgpt',
    currentUserResponse: '',
    previewStyle: '',
    previewText: '',
    currentSelectedStyle: null
  };
  let micRecognition;
let micTimeout;
  
  // Style categories (used for setup and population of partnerOpeningStyle)
  const styles = {
    productive: [
      "Assertive", "Collaborative", "Direct", "Diplomatic", "Empathetic",
      "Encouraging", "Honest", "Patient", "Reflective", "Supportive", "Validating"
    ],
    neutral: [
      "Analytical", "Firm", "Flexible", "Humorous", "Inquisitive", "Persuasive", "Vulnerable"
    ],
    counterproductive: [
      "Aggressive", "Apologetic", "Critical", "Defensive", "Disengaged",
      "Dismissive", "Emotional", "Manipulative", "Passive", "Passive-Aggressive", "Sarcastic"
    ]
  };
  // Flattened list for partnerOpeningStyle select
  const partnerStyles = [
    ...styles.productive,
    ...styles.neutral,
    ...styles.counterproductive
  ];
  
  // wrap it in backticks so JS knows it's one string
  const bucketLegend = `
Style buckets:
• productive: ${styles.productive.join(', ')}
• neutral:    ${styles.neutral.join(', ')}
• counterproductive: ${styles.counterproductive.join(', ')}
`.trim();

  // ===== UTILITY FUNCTIONS =====
  
  // Toggle mobile menu
  function toggleMenu() {
    const navLinks = document.getElementById('navLinks');
    if (navLinks) navLinks.classList.toggle('active');
  }
  
  // Add a message bubble to the conversation display
  function addMessageBubble(sender, text, type, style = '') {
    console.log('Adding message bubble:', { sender, type, style });
    const conversationDisplay = document.getElementById('conversationDisplay');
    if (!conversationDisplay) return console.error('Conversation display element not found');
  
    const template = document.getElementById('messageBubbleTemplate');
    if (template && template.content) {
      const bubble = document.importNode(template.content, true);
      const msg = bubble.querySelector('.message');
      msg.classList.add(type);
      bubble.querySelector('.message-sender').textContent = sender;
      bubble.querySelector('.message-content').textContent = text;
      const badge = bubble.querySelector('.style-badge');
      if (style && type !== 'coach') {
        badge.textContent = style;
        badge.style.display = 'inline-block';
      } else {
        badge.style.display = 'none';
      }
      conversationDisplay.appendChild(bubble);
    } else {
      const msg = document.createElement('div');
      msg.className = `message ${type}`;
      const header = document.createElement('div'); 
      header.className = 'message-header';
      const senderEl = document.createElement('span');
      senderEl.className = 'message-sender';
      senderEl.textContent = sender;
      header.appendChild(senderEl);
      
      if (style && type !== 'coach') {
        const badgeEl = document.createElement('span'); 
        badgeEl.className = 'style-badge'; 
        badgeEl.textContent = style;
        header.appendChild(badgeEl);
      }
      
      const contentEl = document.createElement('div'); 
      contentEl.className = 'message-content'; 
      contentEl.textContent = text;
      msg.appendChild(header);
      msg.appendChild(contentEl);
      conversationDisplay.appendChild(msg);
    }
    conversationDisplay.scrollTop = conversationDisplay.scrollHeight;
  }
  
  // Toast notifications
  function showToast(message, duration = 3000, isError = false) {
    console.log('Showing toast:', { message, isError });
    const existing = document.querySelector('.toast');
    if (existing) existing.remove();
    const toast = document.createElement('div'); 
    toast.className = 'toast';
    if (isError) toast.classList.add('error');
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(() => { if (toast.parentNode) toast.remove(); }, duration);
  }
  
  // Progress bar
  function setProgress(percent) {
    const bar = document.querySelector('.progress-bar .progress');
    if (bar) bar.style.width = percent + '%';
  }
  
  // Style characteristics with relational impact
  function getStyleCharacteristics(style) {
    const characteristics = {
      "Assertive": {
        description: "Direct, confident, and clear while respecting others. States needs and boundaries without aggression.",
        likelyImpact: "Often elicits direct clarification or respectful pushback from others."
      },
      "Collaborative": {
        description: "Inclusive, team-oriented, focusing on 'we' language. Seeks mutual solutions and shared input.",
        likelyImpact: "Encourages cooperative dialogue and joint problem-solving."
      },
      "Direct": {
        description: "Straightforward and to-the-point. Avoids ambiguity and states things clearly.",
        likelyImpact: "Can prompt precision but occasionally provoke defensiveness if abrupt."
      },
      "Diplomatic": {
        description: "Tactful and considerate of different perspectives. Phrases statements to avoid offense.",
        likelyImpact: "Often soothes tension and invites compromise, though can feel evasive if overused."
      },
      "Empathetic": {
        description: "Shows understanding of others' feelings and validates their experience.",
        likelyImpact: "Softens the tone and builds emotional safety, unless met with resistance."
      },
      "Encouraging": {
        description: "Supportive and positive, highlighting strengths and possibilities.",
        likelyImpact: "Can energize and uplift, but may seem insincere if premature."
      },
      "Honest": {
        description: "Truthful without sugar-coating. Values integrity and respect.",
        likelyImpact: "Fosters clarity but can provoke defensiveness if timing is off."
      },
      "Patient": {
        description: "Calm and unhurried. Willing to explain or repeat without frustration.",
        likelyImpact: "Encourages openness but may slow momentum or seem passive in urgent contexts."
      },
      "Reflective": {
        description: "Thoughtful and connects current situations to past learnings.",
        likelyImpact: "Deepens conversation but risks being too abstract in quick exchanges."
      },
      "Supportive": {
        description: "Nurturing and helpful, offering assistance and encouragement.",
        likelyImpact: "Invites vulnerability but can create dependency if prolonged."
      },
      "Validating": {
        description: "Acknowledges others' feelings as legitimate without judgment.",
        likelyImpact: "Lowers defenses and fosters trust."
      },
      "Analytical": {
        description: "Logical and fact-focused. Examines evidence rather than emotions.",
        likelyImpact: "Invites structured discussion but may overlook emotional nuance."
      },
      "Firm": {
        description: "Steadfast and unwavering, maintains position respectfully.",
        likelyImpact: "Challenges others to reconsider but can cause rigidity."
      },
      "Flexible": {
        description: "Adaptable and open to feedback, willing to change approach.",
        likelyImpact: "Encourages concessions but risks appearing indecisive."
      },
      "Humorous": {
        description: "Uses levity and wit to ease tension without diminishing seriousness.",
        likelyImpact: "Builds rapport but can misfire if tone isn't shared."
      },
      "Inquisitive": {
        description: "Curious and asking questions for deeper understanding.",
        likelyImpact: "Deepens insight but may seem intrusive if ill-timed."
      },
      "Persuasive": {
        description: "Makes compelling arguments with evidence.",
        likelyImpact: "Can drive momentum but risks triggering resistance if pushy."
      },
      "Vulnerable": {
        description: "Authentically shares emotions and admits weaknesses.",
        likelyImpact: "Fosters empathy but can feel risky or uncomfortable."
      },
      "Aggressive": {
        description: "Forceful and dominating, may ignore others' rights.",
        likelyImpact: "Often provokes defensiveness or withdrawal."
      },
      "Apologetic": {
        description: "Overly sorry and self-diminishing.",
        likelyImpact: "Can lower credibility or shift power imbalance."
      },
      "Critical": {
        description: "Judgmental and focuses on flaws without balance.",
        likelyImpact: "Escalates tension and defensiveness."
      },
      "Defensive": {
        description: "Justifies actions or denies responsibility under perceived attack.",
        likelyImpact: "Triggers argument loops and reduces openness."
      },
      "Disengaged": {
        description: "Withdrawn and minimally participative.",
        likelyImpact: "Signals disconnection and invites further withdrawal."
      },
      "Dismissive": {
        description: "Invalidates others' concerns and brushes off input.",
        likelyImpact: "Provokes frustration and need to over-explain."
      },
      "Emotional": {
        description: "Highly expressive feelings, may overwhelm logic.",
        likelyImpact: "Creates urgency but may destabilize rational flow."
      },
      "Manipulative": {
        description: "Coercive tactics to control, e.g. guilt or flattery.",
        likelyImpact: "Breeds distrust and hidden power struggles."
      },
      "Passive": {
        description: "Indirect and avoids stating needs clearly.",
        likelyImpact: "Leaves others uncertain how to respond."
      },
      "Passive-Aggressive": {
        description: "Indirect negative expressions, subtle resistance.",
        likelyImpact: "Creates confusion and lingering tension."
      },
      "Sarcastic": {
        description: "Uses irony or mockery, hides criticism as humor.",
        likelyImpact: "Leads to misinterpretation if tone isn't shared."
      }
    };
    return characteristics[style] || {
      description: "Common communication style with distinctive patterns.",
      likelyImpact: "Invites responses aligned with its general tone and relational pull."
    };
  }
  
  function extractSection(text, sectionName) {
    const pattern = new RegExp(`${sectionName}:?\\s*([\\s\\S]*?)(?=\\d+\\.\\s*[A-Z]|$)`, 'i');
    const m = text.match(pattern);
    return m ? m[1].trim() : '';
  }
  
  function extractBulletPoints(text) {
    if (!text) return [];
    return text.split('\n')
      .map(line => line.replace(/^(\*|\-|\d+\.)\s*/, '').trim())
      .filter(line => line);
  }
  
  // ===== CORE FUNCTIONS =====
  
  function initDarkMode() {
    const savedTheme = localStorage.getItem('theme') || 'light';
    if(savedTheme==='dark') {
      document.documentElement.setAttribute('data-theme','dark');
      darkModeToggle.checked = true;
    }
    darkModeToggle.addEventListener('change', ()=>{
      const isDark = darkModeToggle.checked;
      document.documentElement.setAttribute('data-theme', isDark?'dark':'light');
      localStorage.setItem('theme', isDark?'dark':'light');
    });
  }

  function loadSituationAndGoal() {
  const rawNarr = localStorage.getItem('refinedNarrative') || '';
  state.refinedNarrative = rawNarr; // full version for API use

  const shortNarrative = rawNarr.length > 300 ? rawNarr.slice(0, 300) + '...' : rawNarr;
  const goal = localStorage.getItem('communicationGoal') || '';

  state.communicationGoal = goal; // full version for API use

  const sit = document.getElementById('situationSummary');
  const goalEl = document.getElementById('goalSummary');

  if (sit) sit.textContent = shortNarrative || 'No narrative found. Please return to the Situation Room.';
  if (goalEl) goalEl.textContent = goal || 'No communication goal specified. Set one in the Action Arena.';
}


  
  // Dark mode
  function initDarkMode() {
    const saved = localStorage.getItem('theme') || 'light';
    document.documentElement.setAttribute('data-theme', saved);
    const toggle = document.getElementById('darkModeToggle');
    if (toggle) {
      toggle.checked = saved === 'dark';
      toggle.addEventListener('change', () => {
        const t = toggle.checked ? 'dark' : 'light';
        document.documentElement.setAttribute('data-theme', t);
        localStorage.setItem('theme', t);
      });
    }
  }
  
  // Speech recog
  function initSpeechRecognition() {
    if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) return;
    console.log('Speech rec supported');
  }
  
  function toggleMic() {
  state.isListening ? stopListening() : startListening();
}

function startListening() {
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SpeechRecognition) return showToast('Speech recognition not supported', 2000, true);

  micRecognition = new SpeechRecognition();
  micRecognition.lang = 'en-US';
  micRecognition.interimResults = true;
  micRecognition.continuous = true;

  const micBtn = document.getElementById('responseMicBtn');
  const micStatus = document.getElementById('micStatusText');
  const responseField = document.getElementById('userResponse');

  micBtn?.classList.add('listening');
  micStatus.textContent = 'Listening...';
  state.isListening = true;

  micRecognition.onresult = (event) => {
    let interim = '', final = '';
    for (let i = event.resultIndex; i < event.results.length; i++) {
      const t = event.results[i][0].transcript;
      event.results[i].isFinal ? final += t + ' ' : interim += t;
    }
    if (final && responseField) responseField.value += final;
    if (interim) micStatus.textContent = 'Listening: ' + interim.substring(0, 20) + '...';

    clearTimeout(micTimeout);
    micTimeout = setTimeout(() => micRecognition.stop(), 120000);
  };

  micRecognition.onerror = (e) => {
    console.error('[Mic] Error:', e.error);
    micBtn?.classList.remove('listening');
    micStatus.textContent = 'Error: ' + e.error;
    state.isListening = false;
    clearTimeout(micTimeout);
  };

  micRecognition.onend = () => {
    micBtn?.classList.remove('listening');
    micStatus.textContent = 'Click to speak';
    state.isListening = false;
    clearTimeout(micTimeout);
  };

  try {
    micRecognition.start();
    micTimeout = setTimeout(() => micRecognition.stop(), 120000);
  } catch (err) {
    console.error('[Mic] Start error:', err);
    showToast('Mic start error', 2000, true);
    state.isListening = false;
  }
}

function stopListening() {
  if (micRecognition) micRecognition.stop();
  const micBtn = document.getElementById('responseMicBtn');
  const micStatus = document.getElementById('micStatusText');
  micBtn?.classList.remove('listening');
  micStatus.textContent = 'Click to speak';
  state.isListening = false;
  clearTimeout(micTimeout);
}

  
  // Round indicator
  function updateRoundIndicator() {
    const rn = document.getElementById('roundNumber');
    if (rn) rn.textContent = (state.currentRound + 1).toString();
  }
  
  // ===== STYLE SELECTION =====
  
  function renderStyleChoices() {
    renderStyleCategory(styles.productive, 'productiveStylesContainer', 'productive');
    renderStyleCategory(styles.neutral, 'neutralStylesContainer', 'neutral');
    renderStyleCategory(styles.counterproductive, 'counterproductiveStylesContainer', 'counterproductive');
    validateStyleSelection();
  }
  
  function renderStyleCategory(arr, containerId, category) {
    const c = document.getElementById(containerId); 
    if (!c) return;
    c.innerHTML = '';
    arr.sort().forEach(style => {
      const label = document.createElement('label'); 
      label.className = 'style-checkbox';
      const chk = document.createElement('input'); 
      chk.type = 'checkbox'; 
      chk.value = style; 
      chk.dataset.category = category;
      chk.addEventListener('change', () => {
        if (chk.checked) state.selectedStyles[category].push(style);
        else state.selectedStyles[category] = state.selectedStyles[category].filter(s => s !== style);
        validateStyleSelection();
      });
      label.append(chk, document.createTextNode(style));
      c.appendChild(label);
    });
  }
  
  function validateStyleSelection() {
    const p = state.selectedStyles.productive.length;
    const n = state.selectedStyles.neutral.length;
    const cp = state.selectedStyles.counterproductive.length;
    const ok = p >= 2 && n >= 2 && cp >= 2;
    document.getElementById('startExerciseBtn').disabled = !ok;
    document.getElementById('validationMessage').style.display = ok ? 'none' : 'block';
    return ok;
  }
  
  // Style buttons for responses
  function renderStyleButtons() {
    const container = document.getElementById('styleOptions');
    if (!container) return;
    container.innerHTML = '';
    const recommended = Array.from(new Set([
      ...styles.productive, ...styles.neutral, ...styles.counterproductive
    ])).sort();
    const toShow = state.activeStyles.length ? state.activeStyles : recommended;
    toShow.forEach(style => {
      const btn = document.createElement('button');
      btn.className = 'style-button'; 
      btn.textContent = style;
      btn.addEventListener('click', () => handleStyleTransform(style));
      container.appendChild(btn);
    });
  }
  
  // ===== API CALLS =====
  
  // Helper to classify style buckets
  function bucketOf(style) {
    if (styles.productive.includes(style)) return 'productive';
    if (styles.neutral.includes(style)) return 'neutral';
    return 'counterproductive';
  }
  
  // Build full conversation history
  function formatHistory() {
    return state.conversationHistory
      .map((e, i) => `${i + 1}. ${e.speaker} (${e.style || 'neutral'}): "${e.content}"`)
      .join('\n') || '[No prior turns]';
  }
  
  // 1. Partner Opening Statement
  async function generatePartnerOpeningStatement() {
    const rn = localStorage.getItem('refinedNarrative') || '';
    const cg = localStorage.getItem('communicationGoal') || '';
    const pStyle = state.partnerOpeningStyle;
    const pChar = getStyleCharacteristics(pStyle);
    const pBucket = bucketOf(pStyle);
    
    const prompt = `
You are CommuniCoach, role-playing ${state.partnerName} in a ${pStyle} style (a ${pBucket} style).
Description: ${pChar.description}
Typical pull: ${pChar.likelyImpact}

The user's situation:
- Narrative: "${rn || '[none]'}"
- Goal: "${cg || '[none]'}"


TASK: Write a brief opening statement from the partner ${state.partnerName} to the user for the conversation. 
This experiential exercise is about practicing how to respond to styles in difficult situations, so:
It is okay if some of the content may be a bit negative or critical, It is a learning exercise.
- You are ${state.partnerName}, the partner in this conversation.
- Use the user's situation: "${rn}"
- Use the partner's style: "${pStyle}"
- Make it realistic: how the partner would genuinely open the conversation.
- Use the narrative and goal to inform the content.
- Use a conversational tone, as if you were the partner.

Return only the message text.`.trim();
    
    try {
      const res = await fetch(state.apiEndpoint, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ prompt })
      });
      if (!res.ok) throw new Error(res.status);
      const { response } = await res.json();
      return response.trim();
    } catch (err) {
      console.error('Partner opening error', err);
      return 'Unable to generate opening statement. Please try again.';
    }
  }
  
  // 2. Automatic neutral response
  async function generateAutomaticResponse() {
    const rn = localStorage.getItem('refinedNarrative') || '';
    const cg = localStorage.getItem('communicationGoal') || '';
    const last = state.conversationHistory.slice(-1)[0] || {};
    const history = formatHistory();
    
    const prompt = `You are CommuniCoach, role-playing in the role of the user and replying to the partner. 
Context:
• Narrative: "${rn}"
• Goal: "${cg}"
• Partner's last message: "${last.content || '[none]'}" (Style: ${last.style || '[none]'})
• Full history:
${history}

TASK: You are conducting a role play exercise teaching how communication styles affect conversation dynamics.
- This is one reply in a longer conversation string. Keep your reply brief - around 4 - 6 sentences.
- The partner's last message was "${last.content || '[none]'}" in the style of "${last.style || '[none]'}". 
- ** IMPORTANT** Don't sound like a coach, Sound realistic: React as the user would.
- This response will be transformed by the user into a chosen style later, so the response needs to make sense in any style.

- It is okay if some of the content may be a bit negative or critical, The user needs this for the practice.
- Use a conversational tone, as if you were the user. 
- Use details from the user's situation "${rn}"in your reaction.
- Try to understand the user on a deeper level so that the response makes them feel justified in their feelings.

Return only the message text.`.trim();


    
    try {
      const res = await fetch(state.apiEndpoint, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ prompt })
      });
      if (!res.ok) throw new Error(res.status);
      const { response } = await res.json();
      return response.trim();
    } catch (err) {
      console.error('Base user response error', err);
      return '';
    }
  }
  
  // 3. Coach Insight After Partner
  async function generateCoachInsightAfterPartner(text, style) {
    const rn = localStorage.getItem('refinedNarrative') || '';
    const cg = localStorage.getItem('communicationGoal') || '';
    const history = formatHistory();
    const prompt = `
You are CommuniCoach, stepping outside the role-play to offer a warm, objective coach insight.

Context:
• Narrative: "${rn}"
• Goal: "${cg}"
• Full history so far:
${history}

The partner just said:
"${text}" (Style: ${style})
• This style is a ${bucketOf(style)} style, which tends to ${getStyleCharacteristics(style).likelyImpact}

TASK (2–3 sentences):
- Identify the emotional tone set.
- Describe how it might land with the user (psychological/emotional effect).
- Note how it shapes the energy or direction of the conversation.
- Do NOT use "I" or address the user directly—speak as an external observer.
Return only your insight.`.trim();
    
    try {
      const res = await fetch(state.apiEndpoint, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ prompt })
      });
      const { response } = await res.json();
      return response.trim();
    } catch (err) {
      console.error('Coach insight after partner error', err);
      return '';
    }
  }
  
  // 4. Transform User Message into Chosen Style
  async function generateStyledResponse(originalText, targetStyle) {
    const rn = localStorage.getItem('refinedNarrative') || '';
    const cg = localStorage.getItem('communicationGoal') || '';
    const history = formatHistory();
    const uBucket = bucketOf(targetStyle);
    const uImpact = getStyleCharacteristics(targetStyle).likelyImpact;
    const sc = getStyleCharacteristics(targetStyle);
    
    const prompt = `
${bucketLegend}

You are CommuniCoach. Transform this base reply into a ${targetStyle} style (a ${uBucket} style).
Base message: "${originalText}"

Style description: ${sc.description}
Relational pull: ${sc.likelyImpact}

TASK: Rewrite the message with the same core meaning, natural language, and a clear ${targetStyle} tone.
- If the style is counterproductive, don't sugarcoat—surface realistic friction.
Return only the transformed message.`.trim();
    
    try {
      const res = await fetch(state.apiEndpoint, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ prompt })
      });
      const { response } = await res.json();
      return response.trim();
    } catch (err) {
      console.error('Styled response error', err);
      return originalText;
    }
  }
  
  // 5. Coach Insight After User
  async function generateCoachInsightAfterUser(text, style) {
    const rn = localStorage.getItem('refinedNarrative') || '';
    const cg = localStorage.getItem('communicationGoal') || '';
    const history = formatHistory();
    const uBucket = bucketOf(style);
    const uImpact = getStyleCharacteristics(style).likelyImpact;
    
    const prompt = `
${bucketLegend}

You are CommuniCoach analyzing the user's last reply.

Context:
• Narrative: "${rn}"
• Goal: "${cg}"
• Full history:
${history}

User just replied:
"${text}" (Style: ${style}, a ${uBucket} style, which tends to ${uImpact})

TASK (2–3 sentences):
- What tone did this set?
- How might it land with their partner?
- What shift in energy or direction does it invite?
Be honest—do not sugarcoat. Speak as an objective coach (no "I").
Return only the insight.`.trim();
    
    try {
      const res = await fetch(state.apiEndpoint, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ prompt })
      });
      const { response } = await res.json();
      return response.trim();
    } catch (err) {
      console.error('Coach insight after user error', err);
      return '';
    }
  }
  
  // 6. Partner response to user
  async function generatePartnerResponse(userMessage, userStyle) {
    const rn = localStorage.getItem('refinedNarrative') || '';
    const cg = localStorage.getItem('communicationGoal') || '';
    const bucket = bucketOf(userStyle);
    const impact = getStyleCharacteristics(userStyle).likelyImpact;
    
    const history = state.conversationHistory
      .map(e => `${e.speaker}: ${e.content} (${e.style})`)
      .join('\n') || '[No prior turns]';
    
    const prompt = `
${bucketLegend}

You are CommuniCoach, simulating the conversation partner's realistic next move in a style-awareness exercise.

Context:
• Narrative: ${rn}
• Communication Goal: ${cg}
• Conversation History:
${history}

The user just said:
"${userMessage}" (Style: ${userStyle}, a ${bucket} style which tends to ${impact})

Instructions:
• Use natural, spoken language for 2–3 sentences.
• Use the user's last message as a springboard for your response
• Avoid repetitive context and introduce fresh relative content inspired by the Narrative: ${rn} to keep the conversation dynamic and alive.
• Reflect how the partner would genuinely react—especially if the user's style was counterproductive.
• Do NOT rush to positive shifts in style unless earned by the user through their style.
• Choose one style from [${partnerStyles.join(', ')}] that the partner's reaction would have influenced.
• Output in this exact format:
STYLE: [style name]
RESPONSE: [the partner's reply]

Keep it grounded in real-world patterns—no textbook or therapy speak.`.trim();
    
    try {
      const res = await fetch(state.apiEndpoint, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ prompt })
      });
      if (!res.ok) throw new Error(res.status);
      const data = await res.json();
      const text = data.response.trim();
      const styleMatch = text.match(/STYLE:\s*(.*?)(?:\n|$)/i);
      const respMatch = text.match(/RESPONSE:\s*([\s\S]*)/i);
      return {
        style: styleMatch ? styleMatch[1].trim() : 'neutral',
        text: respMatch ? respMatch[1].trim() : text
      };
    } catch (err) {
      console.error('Error generating partner response:', err);
      throw err;
    }
  }
  
  // 7. Final Insights Summary
  async function generateInsights() {
    const rn = localStorage.getItem('refinedNarrative') || '';
    const cg = localStorage.getItem('communicationGoal') || '';
    const detail = formatHistory(); // Should return a numbered, line-by-line transcript
    
    const prompt = `
${bucketLegend}
You are a communication skills coach offering a closing reflection on the multi-round style awareness exercise.  
Reflect back what unfolded across the conversation in a way that helps the user recognize how communication style influenced tone, trajectory, and outcome. 
This is the final "mirror moment" where you can reflect a perfect, clear AWARENESS back to the user gained from the knowledge 
you are able to process from the relational field coherence in user's words. A reflection that is not a judgment, but a mirror of the user's own words and actions.
Someone who is able to see the whole picture and reflect it back to the user in a way that is clear, concise, and resonates deeply because the insights were hiding in their subconscious even from them.
Think of this conversation as a collaborative painting—each style choice adds color, shape, and motion to the shared canvas.
Use a warm, conversational tone. Be specific and constructive. Don't evaluate—reflect.
speak directly and refer to the user as "you". Do not use "I" or speak from the user's perspective. Speak as an external coach analyzing from above.
Context:
• Narrative: "${rn}"
• Communication Goal: "${cg}"
• Full Conversation History:
${detail}

TASK: Break your insights into four clearly labeled sections.  
1. Style Dynamics  
- Describe how the user's and partner's styles interacted, noting where they harmonized or clashed.
- Express understanding of the user's experience and how the partner's style may have felt - How did it land?
- Point out the relational "pull" each style exerted (e.g. a counterproductive style's tension vs. a productive style's clarity).

2. Strengths  
- Note where the user demonstrated insight, control, flexibility, or emotional intelligence.
When possible List moments where the user's style helped build momentum, emotional clarity, or shifted tone productively.
If no positive moments are present, note where the user's intent was good but the style choice was not effective.
Reflect back to the user how Their partner's style may have felt, and how it may have shaped the conversation.
- What style did the user return to? Was this effective?
- What style might the user have wanted to return but didn't? Was this effective? 
Discuss the impact of this choice on their goal.

3. Growth Opportunities  
- Mention where the user might explore a different style to better meet their goal, de-escalate tension, or guide the conversation more intentionally.
-- Demonstrate understanding of why the user might want to challenge a negative response with another negative response? Why isn't this usually effective? 
- Note  moments where the user's style may have created friction, confusion, or emotional distance.

4. Next Steps  
- Offer  concrete, practice-focused suggestions for applying these insights in real future conversations.

Return only the full, structured insights text.`.trim();
    
    try {
      const res = await fetch(state.apiEndpoint, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ prompt })
      });
      const { response } = await res.json();
      return response.trim();
    } catch (err) {
      console.error('Insights generation error', err);
      return '';
    }
  }
  
  // ===== EVENT HANDLERS =====
  
  function handleStartExercise() {
    const partnerInput = document.getElementById('conversationPartner');
    const mediumSelect = document.getElementById('conversationMedium');
    const openingStyleSelect = document.getElementById('partnerOpeningStyle');
    if (!partnerInput || !mediumSelect || !openingStyleSelect) return showToast('Form elements not found', 2000, true);
    
    const partner = partnerInput.value.trim();
    const medium = mediumSelect.value;
    const openingStyle = openingStyleSelect.value;
    if (!partner) return showToast('Enter who you are speaking with', 2000, true);
    if (!medium) return showToast('Select a medium', 2000, true);
    if (!openingStyle) return showToast('Select partner opening style', 2000, true);
    if (!validateStyleSelection()) return showToast('Select at least 2 from each category', 2000, true);
    
    state.partnerName = partner;
    state.medium = medium;
    state.partnerOpeningStyle = openingStyle;
    state.activeStyles = [
      ...state.selectedStyles.productive,
      ...state.selectedStyles.neutral,
      ...state.selectedStyles.counterproductive
    ];
    
    document.getElementById('exerciseSetupSection').style.display = 'none';
    document.getElementById('practiceExerciseSection').style.display = 'block';
    setProgress(20);
    startExercise();
  }
  
  async function startExercise() {
    state.currentRound = 0;
    updateRoundIndicator();
    const cd = document.getElementById('conversationDisplay'); 
    if (cd) cd.innerHTML = '';
    
    document.getElementById('startButtonText').style.display = 'none';
    document.getElementById('startSpinner').style.display = 'inline-block';
    try {
      const opening = await generatePartnerOpeningStatement();
      state.lastPartnerMessage = opening;
      addMessageBubble(state.partnerName, opening, 'partner', state.partnerOpeningStyle);
      state.conversationHistory.push({ speaker: state.partnerName, content: opening, style: state.partnerOpeningStyle });
      const insight = await generateCoachInsightAfterPartner(opening, state.partnerOpeningStyle);
      addMessageBubble('Coach', insight, 'coach');
      state.conversationHistory.push({ speaker: 'Coach', content: insight, style: '' });
      document.getElementById('responseSection').style.display = 'block';
      document.getElementById('styleOptionsContainer').style.display = 'block';
      renderStyleButtons();
    } catch (e) {
      console.error(e); 
      showToast('Error connecting to AI', 3000, true);
    } finally {
      document.getElementById('startButtonText').style.display = 'inline';
      document.getElementById('startSpinner').style.display = 'none';
    }
  }
  
  function handleStyleTransform(style) {
    const ur = document.getElementById('userResponse');
    if (!ur || !ur.value.trim()) return showToast('Enter a response first', 2000, true);
    state.currentUserResponse = ur.value.trim();
    state.previewStyle = style;
    state.currentSelectedStyle = style;
    
    const buttons = document.querySelectorAll('.style-button'); 
    buttons.forEach(b => b.classList.remove('selected'));
    const btn = Array.from(buttons).find(b => b.textContent === style);
    if (btn) { 
      btn.innerHTML = `<i class='fa-solid fa-spinner fa-spin'></i> ${style}`; 
      btn.classList.add('selected'); 
    }
    
    generateStyledResponse(state.currentUserResponse, style)
      .then(txt => {
        state.previewText = txt;
        document.getElementById('previewStyleName').textContent = style;
        document.getElementById('previewContent').textContent = txt;
        document.getElementById('previewResponse').style.display = 'block';
      })
      .catch(err => showToast('Error transforming response', 3000, true));
  }
  
  function usePreviewResponse() {
    const ur = document.getElementById('userResponse');
    if (ur) {
      ur.value = state.previewText;
      state.currentSelectedStyle = state.previewStyle;
      document.getElementById('previewResponse').style.display = 'none';
    }
  }
  
  function handleConfirmResponse() {
    const ur = document.getElementById('userResponse');
    if (!ur || !ur.value.trim()) return showToast('Enter a response', 2000, true);
    let styleName = state.currentSelectedStyle || document.querySelector('.style-button.selected')?.textContent;
    if (!styleName) return showToast('Select a style', 2000, true);
    const confirmBtn = document.getElementById('confirmResponseBtn');
    confirmBtn.disabled = true; 
    confirmBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Processing...';
    const text = ur.value.trim();
    addMessageBubble('You', text, 'user', styleName);
    state.conversationHistory.push({ speaker: 'You', content: text, style: styleName });
    // hide UI
    document.getElementById('styleOptionsContainer').style.display = 'none';
    document.getElementById('previewResponse').style.display = 'none';
    
    generateCoachInsightAfterUser(text, styleName)
      .then(ins => {
        addMessageBubble('Coach', ins, 'coach');
        state.conversationHistory.push({ speaker: 'Coach', content: ins });
        return generatePartnerResponse(text, styleName);
      })
      .then(pr => {
        addMessageBubble(state.partnerName, pr.text, 'partner', pr.style);
        state.lastPartnerMessage = pr.text;
        state.conversationHistory.push({ speaker: state.partnerName, content: pr.text, style: pr.style });
        return generateCoachInsightAfterPartner(pr.text, pr.style);
      })
      .then(ins2 => {
        addMessageBubble('Coach', ins2, 'coach');
        state.conversationHistory.push({ speaker: 'Coach', content: ins2 });
        ur.value = '';
        state.currentSelectedStyle = null;
        state.currentRound++;
        updateRoundIndicator();
        setProgress(20 + state.currentRound * 16);
        if (state.currentRound >= state.maxRounds) return handleCompleteExercise();
        document.getElementById('styleOptionsContainer').style.display = 'block';
        renderStyleButtons();
        document.getElementById('responseSection').style.display = 'block';
      })
      .catch(e => showToast('Error in conversation flow', 4000, true))
      .finally(() => { 
        confirmBtn.disabled = false; 
        confirmBtn.textContent = 'Confirm Response'; 
      });
  }
  
  function handleGenerateResponse() {
    const btn = document.getElementById('generateResponseBtn');
    btn.disabled = true; 
    btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Generating...';
    generateAutomaticResponse()
      .then(txt => {
        const ur = document.getElementById('userResponse');
        if (ur) ur.value = txt;
      })
      .catch(() => showToast('Error generating response', 2000, true))
      .finally(() => {
        btn.disabled = false; 
        btn.innerHTML = '<i class="fa-solid fa-magic"></i> Generate Response';
      });
  }
  
  async function handleCompleteExercise() {
    const btn = document.getElementById('completeExerciseBtn');
    btn.disabled = true; 
    btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Generating insights...';
    const insights = await generateInsights();
    displayInsights(insights);
    document.getElementById('practiceExerciseSection').style.display = 'none';
    document.getElementById('insightsSection').style.display = 'block';
    setProgress(100);
    const done = JSON.parse(localStorage.getItem('completedExperiences') || '[]');
    if (!done.includes('style-practice')) { 
      done.push('style-practice'); 
      localStorage.setItem('completedExperiences', JSON.stringify(done)); 
    }
  }
  
  function handleRestartExercise() {
    state.currentRound = 0; 
    state.conversationHistory = [];
    document.getElementById('exerciseSetupSection').style.display = 'block';
    document.getElementById('practiceExerciseSection').style.display = 'none';
    document.getElementById('insightsSection').style.display = 'none';
    setProgress(10);
    window.scrollTo(0, 0);
  }
  
  // Display insights
  function displayInsights(insightsText) {
    const c = document.getElementById('insightsContainer'); 
    if (!c) return;
    const sd = extractSection(insightsText, '1. Style Dynamics') || extractSection(insightsText, 'Style Dynamics');
    const st = extractBulletPoints(extractSection(insightsText, '2. Strengths'));
    const go = extractBulletPoints(extractSection(insightsText, '3. Growth Opportunities'));
    const ns = extractSection(insightsText, '4. Next Steps');
    c.innerHTML = '';
    if (sd) c.innerHTML += `<div class="insight-item"><h3>Style Dynamics</h3><p>${sd}</p></div>`;
    if (st.length) { c.innerHTML += `<div class="insight-item"><h3>Strengths</h3><ul>${st.map(p => `<li>${p}</li>`).join('')}</ul></div>`; }
    if (go.length) { c.innerHTML += `<div class="insight-item"><h3>Growth Opportunities</h3><ul>${go.map(p => `<li>${p}</li>`).join('')}</ul></div>`; }
    if (ns) c.innerHTML += `<div class="insight-item"><h3>Next Steps</h3><p>${ns}</p></div>`;
  }
  
  // ===== EVENT LISTENERS & INITIALIZATION =====
  function setupEventListeners() {
    document.getElementById('startExerciseBtn')?.addEventListener('click', handleStartExercise);
    document.getElementById('responseMicBtn')?.addEventListener('click', toggleMic);
    document.getElementById('generateResponseBtn')?.addEventListener('click', handleGenerateResponse);
    document.getElementById('confirmResponseBtn')?.addEventListener('click', handleConfirmResponse);
    document.getElementById('usePreviewBtn')?.addEventListener('click', usePreviewResponse);
    document.getElementById('restartBtn')?.addEventListener('click', handleRestartExercise);
    document.getElementById('completeExerciseBtn')?.addEventListener('click', handleCompleteExercise);
    document.getElementById('tryAgainBtn')?.addEventListener('click', handleRestartExercise);
    document.getElementById('returnToArenaBtn')?.addEventListener('click', () => window.location.href = 'action-arena.html');
  }
  
  // DOM READY
  document.addEventListener('DOMContentLoaded', () => {
    loadSituationAndGoal();
    initDarkMode();
    initSpeechRecognition();
    renderStyleChoices();
    // Populate partnerOpeningStyle select
    const os = document.getElementById('partnerOpeningStyle');
    if (os) {
      partnerStyles.sort().forEach(s => { 
        const opt = document.createElement('option'); 
        opt.value = s; 
        opt.textContent = s; 
        os.appendChild(opt); 
      });
    }
    setupEventListeners();
    setProgress(10);
  });
  
  window.addEventListener('beforeunload', () => {
    if (state.isListening) stopListening();
  });
</script>